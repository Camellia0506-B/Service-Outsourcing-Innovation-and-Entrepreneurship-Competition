# PDF Agent æµå¼å¯¹è¯åŠŸèƒ½ - å®ç°æ€»ç»“

## ğŸ“ æ¦‚è¿°

å·²æˆåŠŸä¸º GradQuest é¡¹ç›®çš„ PDF Agent å®ç°äº†**æµå¼é€ token è¿”å›**åŠŸèƒ½ï¼Œæä¾›äº†æ›´å¥½çš„ç”¨æˆ·ä½“éªŒå’Œå®æ—¶äº¤äº’èƒ½åŠ›ã€‚

---

## ğŸ”§ æŠ€æœ¯æ”¹åŠ¨

### 1. **ä¾èµ–æ·»åŠ ** (`pom.xml`)

æ·»åŠ  Spring WebFlux ä¾èµ–ä»¥æ”¯æŒååº”å¼æµï¼š

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-webflux</artifactId>
</dependency>
```

### 2. **DoubaoAPIClient å¢å¼º**

æ–°å¢ `streamChatCompletion()` æ–¹æ³•ï¼š

- è¿”å›ç±»å‹ï¼š`Flux<String>`ï¼ˆååº”å¼æµï¼‰
- ä½¿ç”¨ `HttpClient.sendAsync()` è¿›è¡Œéé˜»å¡å¼æµå¼è¯·æ±‚
- è§£æ SSE æ ¼å¼å“åº”ï¼Œé€ä¸ªæ¨é€ token
- æ”¯æŒæµå¼ä¸­æ–­å’Œé”™è¯¯å¤„ç†

```java
public Flux<String> streamChatCompletion(List<Map<String, Object>> messages)
```

### 3. **PDFAgentService å¢å¼º**

æ–°å¢ `streamChat()` æ–¹æ³•ï¼š

- è¿”å›ç±»å‹ï¼š`Flux<String>`
- æ„å»ºæ¶ˆæ¯åˆ—è¡¨ï¼ˆåŒ…å«å†å²å¯¹è¯å’Œ PDF å›¾åƒï¼‰
- è°ƒç”¨æµå¼ APIï¼Œå®æ—¶è½¬å‘ token
- åœ¨æµç»“æŸåä¿å­˜å®Œæ•´å¯¹è¯åˆ°å†å²

```java
public Flux<String> streamChat(String sessionId, String question)
```

### 4. **PDFAgentController æ–°å¢ç«¯ç‚¹**

æ–°å¢ `/pdf/chat/stream` æ¥å£ï¼š

- æ–¹æ³•ï¼š`POST`
- å“åº”æ ¼å¼ï¼š`text/event-stream` (SSE)
- æ¯ä¸ª token æ ¼å¼åŒ–ä¸º `data: <token>\n\n`

```java
@PostMapping(value = "/chat/stream", produces = MediaType.TEXT_EVENT_STREAM_VALUE)
public Flux<String> streamChatWithPdf(@RequestBody @Validated ChatRequest request)
```

---

## ğŸ“š API æ¥å£

### ç°æœ‰æ¥å£ï¼ˆä¿æŒä¸å˜ï¼‰

| æ¥å£          | æ–¹æ³• | è¯´æ˜                 |
| ------------- | ---- | -------------------- |
| `/pdf/upload` | POST | ä¸Šä¼  PDF æ–‡ä»¶        |
| `/pdf/chat`   | POST | å¸¸è§„å¯¹è¯ï¼ˆå®Œæ•´è¿”å›ï¼‰ |
| `/pdf/clear`  | POST | æ¸…é™¤ä¼šè¯             |

### æ–°å¢æ¥å£

| æ¥å£               | æ–¹æ³• | è¯´æ˜                      | å“åº”æ ¼å¼ |
| ------------------ | ---- | ------------------------- | -------- |
| `/pdf/chat/stream` | POST | æµå¼å¯¹è¯ï¼ˆé€ token è¿”å›ï¼‰ | SSE      |

---

## ğŸ’¡ åŠŸèƒ½å¯¹æ¯”

| ç‰¹æ€§     | å¸¸è§„å¯¹è¯                 | æµå¼å¯¹è¯           |
| -------- | ------------------------ | ------------------ |
| è·¯å¾„     | `/pdf/chat`              | `/pdf/chat/stream` |
| å“åº”æ ¼å¼ | JSON                     | SSE                |
| è¿”å›æ–¹å¼ | ä¸€æ¬¡æ€§è¿”å›å®Œæ•´ç»“æœ       | é€ token å®æ—¶æ¨é€  |
| ç”¨æˆ·ä½“éªŒ | ç­‰å¾…å®Œæ•´å›ç­”åæ˜¾ç¤º       | å®æ—¶æ˜¾ç¤ºç”Ÿæˆè¿‡ç¨‹   |
| å†…å­˜å ç”¨ | è¾ƒé«˜ï¼ˆéœ€è¦ç¼“å­˜å®Œæ•´ç»“æœï¼‰ | è¾ƒä½ï¼ˆæµå¼å¤„ç†ï¼‰   |
| é€‚ç”¨åœºæ™¯ | çŸ­å›ç­”ã€ç®€å•å¯¹è¯         | é•¿æ–‡æœ¬ã€å¤æ‚äº¤äº’   |

---

## ğŸ§ª æµ‹è¯•èµ„æº

### æä¾›çš„æµ‹è¯•å·¥å…·

1. **PowerShell è„šæœ¬** (`test_pdf_agent_stream.ps1`)

   - å®Œæ•´çš„æµç¨‹æµ‹è¯•
   - åŒ…å«ä¸Šä¼ ã€å¯¹è¯ã€å¤šè½®å¯¹è¯ã€æ¸…é™¤
   - å½©è‰²è¾“å‡ºä¾¿äºè§‚å¯Ÿ
   - é€‚åˆ Windows ç”¨æˆ·å¿«é€Ÿæµ‹è¯•

2. **HTML ç½‘é¡µå·¥å…·** (`pdf-agent-test.html`)

   - ç°ä»£åŒ– UI ç•Œé¢
   - å®æ—¶æµå¼æ˜¾ç¤ºæ•ˆæœ
   - Token æ•°å’Œè€—æ—¶ç»Ÿè®¡
   - è·¨å¹³å°æ”¯æŒ

3. **Node.js è„šæœ¬** (`test_pdf_agent.js`)
   - è‡ªåŠ¨åŒ–æµ‹è¯•è„šæœ¬
   - é€‚åˆ CI/CD é›†æˆ
   - è·¨å¹³å°æ”¯æŒ
   - è¯¦ç»†æ—¥å¿—è¾“å‡º

### æµ‹è¯•æŒ‡å—

è¯¦è§ï¼š`æµ‹è¯•æŒ‡å—.md`

---

## ğŸ“– æ–‡æ¡£

### æ–°å¢/æ›´æ–°æ–‡æ¡£

1. **PDF æ™ºèƒ½ä½“ API æ–‡æ¡£\_v2.md**

   - å®Œæ•´çš„ API æ–‡æ¡£
   - è¯¦ç»†çš„æµå¼å¯¹è¯è¯´æ˜
   - JavaScript å®¢æˆ·ç«¯ç¤ºä¾‹
   - SSE æ ¼å¼è¯´æ˜
   - å¸¸è§é—®é¢˜è§£ç­”
   - æ€§èƒ½å»ºè®®

2. **æµ‹è¯•æŒ‡å—.md**

   - ä¸‰ç§æµ‹è¯•æ–¹æ³•è¯¦è§£
   - æ•…éšœæ’æŸ¥æŒ‡å—
   - API å‚è€ƒ
   - æµ‹è¯•å»ºè®®

3. **æœ¬æ–‡æ¡£** (`å®ç°æ€»ç»“.md`)
   - æŠ€æœ¯æ”¹åŠ¨æ€»ç»“
   - åŠŸèƒ½å¯¹æ¯”
   - ä½¿ç”¨æŒ‡å—

---

## ğŸš€ ä½¿ç”¨æŒ‡å—

### å‰ç«¯é›†æˆï¼ˆJavaScriptï¼‰

#### å¸¸è§„å¯¹è¯

```javascript
const response = await fetch("http://localhost:8080/api/v1/pdf/chat", {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({
    question: "è¿™ä»½æ–‡æ¡£çš„ä¸»è¦å†…å®¹æ˜¯ä»€ä¹ˆï¼Ÿ",
    session_id: sessionId,
  }),
});

const data = await response.json();
console.log(data.data.answer);
```

#### æµå¼å¯¹è¯

```javascript
const response = await fetch("http://localhost:8080/api/v1/pdf/chat/stream", {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({
    question: "è¿™ä»½æ–‡æ¡£çš„ä¸»è¦å†…å®¹æ˜¯ä»€ä¹ˆï¼Ÿ",
    session_id: sessionId,
  }),
});

const reader = response.body.getReader();
const decoder = new TextDecoder();
let fullAnswer = "";

while (true) {
  const { done, value } = await reader.read();
  if (done) break;

  const chunk = decoder.decode(value, { stream: true });
  const lines = chunk.split("\n");

  for (const line of lines) {
    if (line.startsWith("data: ")) {
      const token = line.substring(6);
      fullAnswer += token;
      // å®æ—¶æ›´æ–° UI
      document.getElementById("answer").textContent = fullAnswer;
    }
  }
}
```

---

## âœ¨ æ”¹è¿›ç‚¹

### æ€§èƒ½

- âœ… æµå¼å¤„ç†å‡å°‘å†…å­˜å ç”¨
- âœ… éé˜»å¡å¼ I/Oï¼ˆä½¿ç”¨ååº”å¼ç¼–ç¨‹ï¼‰
- âœ… æ”¯æŒä¸­é€”ä¸­æ–­è¿æ¥

### ç”¨æˆ·ä½“éªŒ

- âœ… å®æ—¶æ˜¾ç¤º AI ç”Ÿæˆè¿‡ç¨‹
- âœ… å‡å°‘ç­‰å¾…æ„Ÿ
- âœ… æ›´ç›´è§‚çš„äº¤äº’åé¦ˆ

### ä»£ç è´¨é‡

- âœ… éµå¾ª Spring å“åº”å¼ç¼–ç¨‹æœ€ä½³å®è·µ
- âœ… é”™è¯¯å¤„ç†å®Œå–„
- âœ… æ–‡æ¡£è¯¦ç»†å®Œæ•´

---

## ğŸ“¦ æ–‡ä»¶åˆ—è¡¨

### æ ¸å¿ƒä»£ç 

- `backend/src/main/java/www/gradquest/com/utils/DoubaoAPIClient.java` - API å®¢æˆ·ç«¯ï¼ˆå·²å¢å¼ºï¼‰
- `backend/src/main/java/www/gradquest/com/service/PDFAgentService.java` - æœåŠ¡å±‚ï¼ˆå·²å¢å¼ºï¼‰
- `backend/src/main/java/www/gradquest/com/controller/PDFAgentController.java` - æ§åˆ¶å™¨ï¼ˆå·²å¢å¼ºï¼‰
- `backend/pom.xml` - é¡¹ç›®é…ç½®ï¼ˆå·²æ›´æ–°ï¼‰

### æµ‹è¯•å·¥å…·

- `backend/test_pdf_agent_stream.ps1` - PowerShell æµ‹è¯•è„šæœ¬
- `backend/test_pdf_agent.js` - Node.js æµ‹è¯•è„šæœ¬
- `frontend/pdf-agent-test.html` - HTML ç½‘é¡µæµ‹è¯•å·¥å…·

### æ–‡æ¡£

- `backend/PDFæ™ºèƒ½ä½“APIæ–‡æ¡£_v2.md` - å®Œæ•´ API æ–‡æ¡£
- `backend/æµ‹è¯•æŒ‡å—.md` - æµ‹è¯•æŒ‡å—
- `backend/å®ç°æ€»ç»“.md` - æœ¬æ–‡æ¡£

---

## ğŸ” è´¨é‡æ£€æŸ¥

### ç¼–è¯‘æµ‹è¯•

```bash
cd backend
mvn clean compile
# BUILD SUCCESS âœ“
```

### æ‰“åŒ…æµ‹è¯•

```bash
mvn clean package -DskipTests
# BUILD SUCCESS âœ“
```

### ç±»å‹æ£€æŸ¥

- âœ… æ‰€æœ‰å¯¼å…¥å·²è§£å†³
- âœ… æ— é‡å¤æ–¹æ³•å®šä¹‰
- âœ… æ— æœªä½¿ç”¨çš„ä»£ç 

---

## ğŸ¯ åç»­å»ºè®®

### çŸ­æœŸ

1. éƒ¨ç½²æµ‹è¯•ç¯å¢ƒå¹¶éªŒè¯åŠŸèƒ½
2. å‰ç«¯é›†æˆæµå¼å¯¹è¯æ¥å£
3. ç”¨æˆ·ä½“éªŒåé¦ˆæ”¶é›†

### ä¸­æœŸ

1. æ€§èƒ½ä¼˜åŒ–å’Œå‹åŠ›æµ‹è¯•
2. é”™è¯¯å¤„ç†å¢å¼º
3. æ–‡æ¡£å®Œå–„å’Œç¤ºä¾‹è¡¥å……

### é•¿æœŸ

1. æ”¯æŒå–æ¶ˆæ­£åœ¨è¿›è¡Œçš„å¯¹è¯
2. æµå¼å“åº”ç¼“å­˜ä¼˜åŒ–
3. å¤šæ¨¡å‹æ”¯æŒ

---

## ğŸ“ æ”¯æŒ

### å¸¸è§é—®é¢˜

**Q: æµå¼å¯¹è¯å’Œå¸¸è§„å¯¹è¯æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ**
A: å¸¸è§„å¯¹è¯ç­‰å¾…å®Œæ•´å›ç­”åä¸€æ¬¡æ€§è¿”å›ï¼Œæµå¼å¯¹è¯åœ¨ AI ç”Ÿæˆæ—¶å®æ—¶æ¨é€æ¯ä¸ª tokenï¼Œç”¨æˆ·å¯ä»¥å³æ—¶çœ‹åˆ°ç”Ÿæˆè¿‡ç¨‹ã€‚

**Q: æ˜¯å¦å¯ä»¥ä¸­é€”åœæ­¢æµå¼å¯¹è¯ï¼Ÿ**
A: æ˜¯çš„ï¼Œæµè§ˆå™¨ç«¯å¯ä»¥è°ƒç”¨ `reader.cancel()` ä¸­æ–­è¯»å–ï¼Œåç«¯ä¼šè‡ªåŠ¨å…³é—­è¿æ¥ã€‚

**Q: æ”¯æŒå¤šè½®å¯¹è¯å—ï¼Ÿ**
A: æ˜¯çš„ï¼Œç³»ç»Ÿè‡ªåŠ¨è®°å½•å¯¹è¯å†å²ï¼Œä½¿ç”¨åŒä¸€ä¸ª `session_id` å³å¯è¿›è¡Œå¤šè½®å¯¹è¯ã€‚

**Q: PDF é¡µæ•°æœ‰é™åˆ¶å—ï¼Ÿ**
A: API æ”¯æŒæ— é™é¡µæ•°ï¼Œä½†æ¯æ¬¡å¯¹è¯åªå¤„ç†å‰ 10 é¡µä»¥ç¡®ä¿æ€§èƒ½ã€‚

---

## ğŸ“ å˜æ›´æ—¥å¿—

### v2.0 (å½“å‰ç‰ˆæœ¬)

- âœ… å®ç°æµå¼å¯¹è¯æ¥å£ `/pdf/chat/stream`
- âœ… æ·»åŠ  Spring WebFlux ä¾èµ–
- âœ… å®ç° SSE æ ¼å¼æµå¼å“åº”
- âœ… é€ token å®æ—¶æ¨é€ AI å›ç­”
- âœ… æä¾›å¤šç§æµ‹è¯•å·¥å…·
- âœ… ç¼–å†™å®Œæ•´çš„ API æ–‡æ¡£å’Œæµ‹è¯•æŒ‡å—

### v1.0 (åŸºç¡€ç‰ˆæœ¬)

- åŸºç¡€çš„ PDF ä¸Šä¼ å’Œå¯¹è¯åŠŸèƒ½
- å¸¸è§„å¯¹è¯æ¥å£
- ä¼šè¯ç®¡ç†

---

## âœ… äº¤ä»˜æ¸…å•

- [x] ä»£ç å®ç°
- [x] ç¼–è¯‘éªŒè¯
- [x] å•å…ƒæµ‹è¯•å·¥å…·
- [x] API æ–‡æ¡£
- [x] æµ‹è¯•æŒ‡å—
- [x] å®ç°æ€»ç»“

---

**é¡¹ç›®çŠ¶æ€**: âœ… å®Œæˆ

**æœ€åæ›´æ–°**: 2026-01-04

---

ç¥ä½ ä½¿ç”¨æ„‰å¿«ï¼å¦‚æœ‰ä»»ä½•é—®é¢˜ï¼Œæ¬¢è¿åé¦ˆã€‚ ğŸš€
