# PDF Agent 流式对话测试指南

本项目提供了多种测试 PDF Agent 流式对话功能的方法。

## 📋 快速开始

### 前提条件

- 后端服务运行在 `http://localhost:8080`
- 已准备好测试用的 PDF 文件

## 🧪 测试方法

### 方法 1: PowerShell 脚本（Windows）

最简单和最直观的测试方式。

#### 步骤：

1. **准备 PDF 文件**

   ```powershell
   # 将你的 PDF 文件放在 backend 目录下，或修改脚本中的 $PdfFilePath
   ```

2. **运行测试脚本**

   ```powershell
   cd backend
   .\test_pdf_agent_stream.ps1
   ```

3. **查看输出**
   - ✓ 显示成功操作
   - ✗ 显示失败操作
   - 彩色输出便于阅读

#### 功能：

- ✓ 上传 PDF 文件
- ✓ 测试常规对话接口
- ✓ 测试流式对话接口（实时显示 token 流）
- ✓ 测试多轮对话
- ✓ 清除会话

**优点**：

- 完整的流程测试
- 实时显示流式响应的 token
- 彩色输出便于理解
- 包含错误处理

---

### 方法 2: HTML 网页测试（跨平台）

现代化的图形界面测试工具，支持所有浏览器。

#### 步骤：

1. **打开网页**

   - 在浏览器中打开 `frontend/pdf-agent-test.html`
   - 或使用以下 URL：`file:///path/to/pdf-agent-test.html`

2. **使用界面**

   ```
   左面板：
   1. 选择 PDF 文件 → 上传 PDF
   2. 输入问题 → 选择对话方式
   3. 查看会话信息和管理选项

   右面板：
   - 显示实时输出结果
   - 显示统计信息（Token 数、耗时）
   ```

3. **测试流程**
   - 上传 PDF 文件
   - 查看上传成功提示和会话信息
   - 输入问题，选择"常规对话"或"流式对话"
   - 查看输出和统计信息
   - 清除会话或继续提问

**功能**：

- ✓ 上传 PDF 文件
- ✓ 常规对话（一次性返回完整回答）
- ✓ 流式对话（逐 token 返回，实时显示）
- ✓ 会话管理
- ✓ 性能统计

**优点**：

- 现代化 UI 界面
- 实时流式显示效果可视化
- Token 数和耗时统计
- 支持多轮对话
- 跨平台（任何有浏览器的系统）

---

### 方法 3: Node.js 脚本

适合自动化测试和集成测试。

#### 步骤：

1. **安装依赖**（如果需要）

   ```bash
   # Node.js 是跨平台的，无需额外依赖（使用内置 http 模块）
   ```

2. **运行测试**

   ```bash
   node backend/test_pdf_agent.js <pdf-file-path>
   ```

   例如：

   ```bash
   node backend/test_pdf_agent.js ./test.pdf
   node backend/test_pdf_agent.js D:\test.pdf
   ```

3. **查看输出**
   - 详细的步骤输出
   - 彩色代码标记（✓ 成功，✗ 失败）
   - 实时流式响应展示

**功能**：

- ✓ 完整的测试流程
- ✓ 详细的输出信息
- ✓ 自动化测试支持
- ✓ 流式响应演示

**优点**：

- 适合 CI/CD 集成
- 详细的日志输出
- 可编程化扩展
- 跨平台支持（Windows、Linux、macOS）

---

## 📊 测试输出示例

### PowerShell 脚本输出

```
========================================
PDF Agent 流式对话测试脚本
========================================

[1] 上传 PDF 文件...
✓ PDF 上传成功
  Session ID: 550e8400-e29b-41d4-a716-446655440000
  文件名: document.pdf
  页数: 10

[2] 测试常规对话接口...
✓ 常规对话成功
回答: 这份文档主要介绍了...

[3] 测试流式对话接口...
✓ 流式对话连接成功
流式响应内容:
这份文档 中 最 重 要 的 信 息 是 ...
✓ 流式对话完成
  Token 总数: 150
  完整回答长度: 450
```

### HTML 网页输出

- 左面板：上传控件、问题输入、会话信息
- 右面板：实时输出、Token 数统计、耗时显示

### Node.js 脚本输出

```
==================================================
PDF Agent 流式对话测试
==================================================

1. 上传 PDF 文件
✓ PDF 上传成功
  Session ID: 550e8400-e29b-41d4-a716-446655440000
  文件名: document.pdf
  页数: 10

2. 常规对话测试
✓ 常规对话成功

回答:
这份文档的主要内容是...

3. 流式对话测试
✓ 连接成功

流式响应:
这份文档中最重要的信息是...
✓ 流式对话完成
  Token 数: 150
  回答长度: 450 字符
```

---

## 🔧 故障排查

### 问题 1: 连接被拒绝

**错误信息**：`ECONNREFUSED` 或 `无法连接到 localhost:8080`

**解决方案**：

1. 确保后端服务正在运行
   ```bash
   cd backend
   java -jar target/backend-1.0.0-RELEASE.jar
   ```
2. 检查端口是否被占用
   ```powershell
   netstat -an | findstr :8080
   ```
3. 确保服务监听在 `0.0.0.0:8080`

### 问题 2: CORS 错误（HTML 网页）

**错误信息**：`Access to XMLHttpRequest blocked by CORS policy`

**解决方案**：

1. 确保后端启用了 CORS（应该已默认启用）
2. 在 HTML 文件中修改 API_BASE 为正确的后端地址
   ```javascript
   const API_BASE = "http://localhost:8080/api/v1";
   ```

### 问题 3: 文件上传失败

**错误信息**：`文件不能为空` 或 `文件类型错误`

**解决方案**：

1. 确保选择的是有效的 PDF 文件
2. 检查文件大小是否超过限制
3. 确保文件未被其他程序占用

### 问题 4: 流式对话无响应

**错误信息**：`收不到流式响应` 或 `连接超时`

**解决方案**：

1. 检查网络连接是否正常
2. 尝试使用常规对话接口先测试连接
3. 检查后端日志是否有错误
4. 确保 Doubao API 密钥配置正确

---

## 📝 API 参考

### 上传 PDF

```
POST /api/v1/pdf/upload
Content-Type: multipart/form-data

参数：
- file: 二进制 PDF 文件
- session_id: (可选) 会话 ID

响应：
{
  "code": 200,
  "msg": "PDF 上传成功",
  "data": {
    "session_id": "uuid",
    "page_count": 10,
    "filename": "document.pdf"
  }
}
```

### 常规对话

```
POST /api/v1/pdf/chat
Content-Type: application/json

请求体：
{
  "question": "问题内容",
  "session_id": "uuid"
}

响应：
{
  "code": 200,
  "msg": "success",
  "data": {
    "answer": "回答内容",
    "session_id": "uuid"
  }
}
```

### 流式对话

```
POST /api/v1/pdf/chat/stream
Content-Type: application/json

请求体：
{
  "question": "问题内容",
  "session_id": "uuid"
}

响应：
Content-Type: text/event-stream

data: token1
data: token2
data: token3
...
```

### 清除会话

```
POST /api/v1/pdf/clear
Content-Type: application/json

请求体：
{
  "session_id": "uuid"
}

响应：
{
  "code": 200,
  "msg": "会话已清除",
  "data": null
}
```

---

## 🎯 测试建议

1. **基础流程测试**

   - 使用 PowerShell 脚本进行完整的流程测试
   - 验证上传、对话、清除等功能都正常工作

2. **UI 测试**

   - 使用 HTML 网页测试用户交互体验
   - 检查实时流式显示是否流畅

3. **自动化测试**

   - 使用 Node.js 脚本进行持续集成测试
   - 可编写脚本批量测试多个 PDF 文件

4. **性能测试**

   - 记录流式对话的 Token 数和耗时
   - 比较常规对话和流式对话的性能差异
   - 测试大型 PDF 文件的处理能力

5. **压力测试**
   - 并发上传多个 PDF 文件
   - 同时发送多个对话请求
   - 监测系统资源使用情况

---

## 📚 更多信息

详细的 API 文档请参考：[PDF 智能体 API 文档\_v2.md](./PDF智能体API文档_v2.md)

---

## 📄 文件说明

| 文件                              | 说明                           |
| --------------------------------- | ------------------------------ |
| `test_pdf_agent_stream.ps1`       | PowerShell 测试脚本（Windows） |
| `test_pdf_agent.js`               | Node.js 测试脚本（跨平台）     |
| `../frontend/pdf-agent-test.html` | HTML 网页测试工具              |
| `PDF智能体API文档_v2.md`          | 完整 API 文档                  |
| `快速测试指南.md`                 | 本文件                         |

---

祝你测试愉快！ 🚀
