# PDF 智能体 - 快速测试指南

## 快速开始

### 1. 设置环境变量

**Windows PowerShell:**

```powershell
$env:ARK_API_KEY="your-api-key-here"
```

**Windows CMD:**

```cmd
set ARK_API_KEY=your-api-key-here
```

**Linux/Mac:**

```bash
export ARK_API_KEY="your-api-key-here"
```

### 2. 启动后端服务

```bash
cd backend
mvn spring-boot:run
```

或者使用 IDE 运行 `GradQuestApplication.java`

服务启动后，访问地址：`http://localhost:5000`

### 3. 运行测试脚本

**Windows (PowerShell):**

```powershell
cd backend
.\test_pdf_agent.ps1
```

**Linux/Mac:**

```bash
cd backend
chmod +x test_pdf_agent.sh
./test_pdf_agent.sh
```

### 4. 手动测试（使用 curl）

#### 步骤 1: 上传 PDF

```bash
curl -X POST "http://localhost:5000/api/v1/pdf/upload" \
  -F "file=@src/main/resources/test.pdf"
```

**响应示例：**

```json
{
  "code": 200,
  "msg": "PDF 上传成功",
  "data": {
    "session_id": "550e8400-e29b-41d4-a716-446655440000",
    "page_count": 5,
    "filename": "test.pdf"
  }
}
```

**保存返回的 `session_id`**

#### 步骤 2: 提问

```bash
curl -X POST "http://localhost:5000/api/v1/pdf/chat" \
  -H "Content-Type: application/json" \
  -d '{
    "question": "这个文档的主要内容是什么？",
    "session_id": "你的session_id"
  }'
```

**响应示例：**

```json
{
  "code": 200,
  "msg": "success",
  "data": {
    "answer": "AI 回答内容...",
    "session_id": "550e8400-e29b-41d4-a716-446655440000"
  }
}
```

#### 步骤 3: 清除会话（可选）

```bash
curl -X POST "http://localhost:5000/api/v1/pdf/clear" \
  -H "Content-Type: application/json" \
  -d '{
    "session_id": "你的session_id"
  }'
```

## 使用 Postman 测试

### 1. 创建 Collection

创建新的 Postman Collection，命名为 "PDF Agent"

### 2. 上传 PDF 请求

- **Method**: `POST`
- **URL**: `http://localhost:5000/api/v1/pdf/upload`
- **Body**:
  - 选择 `form-data`
  - 添加 key: `file`, type: `File`, value: 选择 PDF 文件
  - (可选) 添加 key: `session_id`, type: `Text`

### 3. 提问请求

- **Method**: `POST`
- **URL**: `http://localhost:5000/api/v1/pdf/chat`
- **Headers**:
  - `Content-Type: application/json`
- **Body**:
  - 选择 `raw` -> `JSON`
  - 内容：

```json
{
  "question": "这个文档的主要内容是什么？",
  "session_id": "{{session_id}}"
}
```

- 在 Tests 标签中添加：

```javascript
var jsonData = pm.response.json();
pm.environment.set("session_id", jsonData.data.session_id);
```

### 4. 清除会话请求

- **Method**: `POST`
- **URL**: `http://localhost:5000/api/v1/pdf/clear`
- **Headers**:
  - `Content-Type: application/json`
- **Body**:
  - 选择 `raw` -> `JSON`
  - 内容：

```json
{
  "session_id": "{{session_id}}"
}
```

## 测试检查清单

- [ ] 环境变量 `ARK_API_KEY` 已设置
- [ ] 后端服务已启动（端口 5000）
- [ ] 可以访问 `http://localhost:5000/api/v1/pdf/upload`
- [ ] 可以成功上传 PDF 文件
- [ ] 可以成功获取 `session_id`
- [ ] 可以成功提问并获取回答
- [ ] 多轮对话功能正常（使用相同 `session_id` 多次提问）
- [ ] 错误处理正常（无效 `session_id`、空问题等）

## 常见问题

### 问题 1: 环境变量未设置

**错误信息**: `请设置环境变量 ARK_API_KEY 或配置 doubao.api.key`

**解决方法**:

- 确保已设置环境变量
- 或在 `application.yml` 中直接配置 `doubao.api.key`

### 问题 2: PDF 处理失败

**错误信息**: `PDF 文件处理失败，无法提取页面`

**解决方法**:

- 检查 PDF 文件是否完整
- 确保 PDF 文件未加密
- 尝试使用其他 PDF 文件

### 问题 3: API 调用失败

**错误信息**: `API 调用失败: HTTP 401`

**解决方法**:

- 检查 API Key 是否正确
- 验证 API Key 是否有效
- 检查网络连接

### 问题 4: 端口被占用

**错误信息**: `Address already in use`

**解决方法**:

- 修改 `application.yml` 中的端口号
- 或关闭占用 5000 端口的程序

## 下一步

测试通过后，可以：

1. 集成到前端页面
2. 添加更多功能（如流式响应）
3. 优化性能（如使用 Redis 存储会话）
4. 添加错误处理和日志
