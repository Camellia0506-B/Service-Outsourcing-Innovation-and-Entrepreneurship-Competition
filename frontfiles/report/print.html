<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èŒä¸šæµ‹è¯„æŠ¥å‘Š - æ‰“å°</title>
    <link rel="stylesheet" href="../styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: #fff;
            color: #1a1a2e;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "PingFang SC", "Microsoft YaHei", sans-serif;
            padding: 24px 16px 48px;
            max-width: 794px;
            margin: 0 auto;
            min-height: 100vh;
        }
        .no-print {
            margin-bottom: 20px;
        }
        .btn-print-pdf {
            padding: 12px 24px;
            background: #4a90e2;
            color: #fff;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            font-weight: 500;
        }
        .btn-print-pdf:hover { background: #357abd; }
        #reportPrintContent.loading { padding: 40px; text-align: center; color: #666; }
        #reportPrintContent.error { padding: 40px; text-align: center; color: #c62828; }
        /* æ‰“å°ç”¨ï¼šæ— é˜´å½±ã€A4 å®½åº¦å·²ç”± body max-width æ§åˆ¶ */
        @media print {
            body { padding: 0; background: #fff; max-width: 100%; }
            .no-print { display: none !important; }
            .report-header-card { box-shadow: none !important; }
            .report-section-card, .report-summary-card, .report-chart-card { box-shadow: none !important; border: 1px solid #eee !important; }
        }
    </style>
</head>
<body>
    <div id="printActions" class="no-print" style="display: none;">
        <button type="button" class="btn-print-pdf" id="btnPrintPdf">å¯¼å‡º PDF</button>
    </div>
    <div id="reportPrintContent">
        <p class="loading">åŠ è½½æŠ¥å‘Šä¸­...</p>
    </div>

    <script src="../api.js"></script>
    <script>
(function() {
        var params = new URLSearchParams(location.search);
        var reportId = params.get('report_id') || params.get('id');
        var container = document.getElementById('reportPrintContent');
        var btnPrint = document.getElementById('btnPrintPdf');

        function formatDateTime(dateString) {
            if (!dateString) return new Date().toLocaleDateString('zh-CN', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
            try {
                var d = new Date(dateString);
                return d.getFullYear() + 'å¹´' + String(d.getMonth() + 1).padStart(2, '0') + 'æœˆ' + String(d.getDate()).padStart(2, '0') + 'æ—¥ ' + String(d.getHours()).padStart(2, '0') + ':' + String(d.getMinutes()).padStart(2, '0');
            } catch (e) { return dateString; }
        }

        function safePct(n) {
            var v = Number(n);
            return (typeof v === 'number' && isFinite(v)) ? Math.max(0, Math.min(100, v)) : 0;
        }
        function safeAbilityScore(n) {
            var v = Number(n);
            return (typeof v === 'number' && isFinite(v)) ? Math.max(60, Math.min(100, v)) : 60;
        }
        function toNum(v) { var n = Number(v); return (typeof n === 'number' && isFinite(n)) ? n : 0; }

        function renderReport(data) {
            var interest = data.interest_analysis || {};
            var primary = interest.primary_interest || {};
            var dist = interest.interest_distribution || [];
            var fields = interest.suitable_fields || [];
            var personality = data.personality_analysis || {};
            var mbti = personality.mbti_type || 'â€”';
            var traits = personality.traits || [];
            var ability = data.ability_analysis || {};
            var strengths = ability.strengths || [];
            var areas = ability.areas_to_improve || [];
            var rec = data.recommendations || {};
            var careers = rec.suitable_careers || [];
            var suggestions = rec.development_suggestions || [];
            var genTime = formatDateTime(data.created_at || data.assessment_date);
            var allAbilitiesRaw = (strengths || []).concat(areas || []);
            var uniqueAbilities = [];
            var seen = {};
            allAbilitiesRaw.forEach(function(a) {
                var key = a.ability || a.name || '';
                if (key && !seen[key]) { seen[key] = true; uniqueAbilities.push(a); }
            });
            var allAbilities = uniqueAbilities.length ? uniqueAbilities : allAbilitiesRaw;
            var sortedByScore = allAbilities.slice().sort(function(a, b) { return (Number(b.score) || 0) - (Number(a.score) || 0); });
            var topAbility = sortedByScore[0] || null;
            var secondAbility = sortedByScore[1] || null;
            var careerFields = (fields.length ? fields : careers.map(function(c) { return c.career; })).slice(0, 5);

            var traitsHtml = '';
            var TRAIT_MAX_SCORE = 100;
            if (traits.length) {
                traitsHtml = '<div class="report-section-card"><div class="report-section-title"><span class="dot"></span>æ€§æ ¼ç‰¹è´¨åˆ†æ â€” ' + mbti + '</div><div class="report-trait-list">';
                traits.forEach(function(t) {
                    var scoreNum = Number(t.score) || 0;
                    var pct = safePct((scoreNum / TRAIT_MAX_SCORE) * 100);
                    var levelClass = pct >= 60 ? 'report-level-high' : pct >= 40 ? 'report-level-mid' : 'report-level-low';
                    var levelText = t.level || (pct >= 60 ? 'åå¼º' : pct >= 40 ? 'ä¸­ç­‰' : 'åä½');
                    traitsHtml += '<div class="report-trait-item"><span class="report-trait-name">' + (t.trait_name || '') + '</span><div class="report-trait-bar-bg"><div class="report-trait-bar" style="width:' + pct + '%; background:linear-gradient(90deg,#667eea,#764ba2)"></div></div><span class="report-trait-score">' + (t.score || 0) + 'åˆ† <span class="report-level-tag ' + levelClass + '">' + levelText + '</span></span></div>';
                });
                traitsHtml += '</div></div>';
            }

            var abilityCardsHtml = '';
            allAbilities.forEach(function(a) {
                var score = safeAbilityScore(a.score);
                var color = score >= 75 ? '#48bb78' : score >= 60 ? '#f5a623' : '#e94560';
                var level = score >= 80 ? 'ä¼˜ç§€' : score >= 70 ? 'è‰¯å¥½' : score >= 60 ? 'ä¸€èˆ¬' : 'é‡ç‚¹æå‡';
                var levelTag = score >= 70 ? 'report-level-high' : score >= 50 ? 'report-level-mid' : 'report-level-low';
                abilityCardsHtml += '<div class="report-ability-card"><div class="report-ability-name">' + (a.ability || '') + '</div><div class="report-ability-score-row"><span class="report-ability-score" style="color:' + color + '">' + score + 'åˆ†</span><span class="report-level-tag ' + levelTag + '">' + level + '</span></div><div class="report-ability-bar-bg"><div class="report-ability-bar" style="width:' + score + '%; background:linear-gradient(90deg,' + color + ',' + color + '99)"></div></div></div>';
            });

            var suggestionsHtml = '';
            if (suggestions.length) {
                suggestionsHtml = '<div class="report-section-card"><div class="report-section-title"><span class="dot"></span>AI ä¸ªæ€§åŒ–å‘å±•å»ºè®®</div><div class="report-suggestion-block"><span class="report-suggestion-icon">ğŸ’­</span><div class="report-suggestion-text">' + suggestions.join(' ') + '</div></div></div>';
            }

            var careerChipsHtml = careerFields.map(function(name, i) {
                return '<div class="report-career-chip"><span class="num">' + String(i + 1).padStart(2, '0') + '</span>' + name + '</div>';
            }).join('');

            container.innerHTML = '<div id="report-content" class="report-wrap">' +
                '<div class="report-header-card"><div class="header-tag">CAREER ASSESSMENT REPORT</div><h3>' + (data.title || 'èŒä¸šæµ‹è¯„æŠ¥å‘Š') + '</h3><p class="header-sub">åŸºäº Holland RIASEC Ã— MBTI åŒç»´åº¦ç»¼åˆåˆ†æ</p><div class="header-meta"><div class="meta-item"><span class="meta-label">Holland Code</span><span class="meta-value">' + (interest.holland_code || 'â€”') + '</span></div><div class="meta-item"><span class="meta-label">MBTI ç±»å‹</span><span class="meta-value">' + mbti + '</span></div><div class="meta-item"><span class="meta-label">å…´è¶£åŒ¹é…åº¦</span><span class="meta-value">' + (primary.score != null ? primary.score + 'åˆ†' : 'â€”') + '</span></div><div class="meta-item"><span class="meta-label">ç”Ÿæˆæ—¶é—´</span><span class="meta-value">' + genTime + '</span></div></div></div>' +
                '<div class="report-summary-grid"><div class="report-summary-card c1"><div class="card-icon">âœ¨</div><div class="card-label">ä¸»è¦å…´è¶£ç±»å‹</div><div class="card-value">' + (primary.type || 'â€”') + '</div><div class="card-sub">' + ((primary.description || '').slice(0, 40)) + '</div></div><div class="report-summary-card c2"><div class="card-icon">â˜€ï¸</div><div class="card-label">ä¼˜åŠ¿èƒ½åŠ›</div><div class="card-value">' + ((strengths[0] || topAbility) ? (strengths[0] || topAbility).ability + ' ' + safeAbilityScore((strengths[0] || topAbility).score) + 'åˆ†' : 'â€”') + '</div><div class="card-sub">' + ((strengths[1] || secondAbility) ? (strengths[1] || secondAbility).ability + ' ' + safeAbilityScore((strengths[1] || secondAbility).score) + 'åˆ†' : '') + '</div></div><div class="report-summary-card c3"><div class="card-icon">ğŸ¯</div><div class="card-label">æœ€åŒ¹é…èŒä¸š</div><div class="card-value">' + (careers[0] ? careers[0].career : (fields[0] || 'â€”')) + '</div><div class="card-sub">' + (fields.slice(1, 3).join(' Â· ') || '') + '</div></div></div>' +
                '<div class="report-charts-grid"><div class="report-chart-card"><div class="report-chart-title">Holland å…´è¶£åˆ†å¸ƒ</div><div class="report-chart-wrap"><canvas id="reportHollandChart"></canvas></div></div><div class="report-chart-card"><div class="report-chart-title">èƒ½åŠ›è¯„åˆ†å¯¹æ¯”</div><div class="report-chart-wrap"><canvas id="reportAbilityBar"></canvas></div></div>' +
                '<div class="report-section-card"><div class="report-section-title"><span class="dot"></span>ç»¼åˆèƒ½åŠ›å›¾è°±</div><div class="report-radar-wrap"><canvas id="reportRadarChart"></canvas></div></div>' +
                traitsHtml +
                '<div class="report-section-card"><div class="report-section-title"><span class="dot"></span>é€‚åˆèŒä¸šé¢†åŸŸæ¨è</div><div class="report-career-grid">' + careerChipsHtml + '</div></div>' +
                '<div class="report-section-card"><div class="report-section-title"><span class="dot"></span>èƒ½åŠ›è¯¦ç»†åˆ†æ</div><div class="report-ability-grid">' + abilityCardsHtml + '</div></div>' +
                suggestionsHtml +
                '<div class="report-footer-text">æœ¬æŠ¥å‘Šç”± AI èŒä¸šè§„åˆ’æ™ºèƒ½ä½“ç”Ÿæˆ Â· ä»…ä¾›å‚è€ƒï¼Œå…·ä½“å†³ç­–è¯·ç»“åˆä¸ªäººå®é™…æƒ…å†µ</div></div>';

            var hollandLabels = dist.length ? dist.map(function(d) { return d.type; }) : ['è‰ºæœ¯å‹(A)', 'ä¼ä¸šå‹(E)', 'ç ”ç©¶å‹(I)', 'ç¤¾ä¼šå‹(S)', 'å¸¸è§„å‹(C)', 'å®ç”¨å‹(R)'];
            var hollandValues = (dist.length ? dist.map(function(d) { return d.score; }) : [35, 25, 20, 10, 6, 4]).map(toNum);
            var abilityLabels = allAbilities.map(function(a) { return a.ability; });
            var abilityValues = allAbilities.map(function(a) { return safeAbilityScore(a.score); });
            var radarLabels = traits.map(function(t) { return t.trait_name; });
            var radarValues = traits.map(function(t) { return safePct(toNum(t.score)); });
            var colors = ['#e94560', '#f5a623', '#667eea', '#48bb78', '#4facfe', '#a8dadc'];

            if (typeof Chart !== 'undefined') {
                var pie = container.querySelector('#reportHollandChart');
                if (pie && pie.getContext) {
                    new Chart(pie.getContext('2d'), { type: 'doughnut', data: { labels: hollandLabels, datasets: [{ data: hollandValues, backgroundColor: colors.slice(0, hollandLabels.length), borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, cutout: '65%', plugins: { legend: { position: 'right' } } } });
                }
                var bar = container.querySelector('#reportAbilityBar');
                if (bar && bar.getContext) {
                    new Chart(bar.getContext('2d'), { type: 'bar', data: { labels: abilityLabels, datasets: [{ label: 'å¾—åˆ†', data: abilityValues, backgroundColor: abilityValues.map(function(v) { return v >= 70 ? '#48bb78cc' : v >= 50 ? '#f5a623cc' : '#e94560cc'; }), borderRadius: 8 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { max: 100 }, x: { grid: { display: false } } } } });
                }
                var radar = container.querySelector('#reportRadarChart');
                if (radar && radar.getContext && radarLabels.length > 0) {
                    new Chart(radar.getContext('2d'), { type: 'radar', data: { labels: radarLabels, datasets: [{ label: 'æˆ‘çš„å¾—åˆ†', data: radarValues, backgroundColor: 'rgba(233,69,96,0.18)', borderColor: '#e94560', borderWidth: 2, pointBackgroundColor: '#e94560' }, { label: 'è¡Œä¸šå¹³å‡', data: radarLabels.map(function() { return 60; }), borderColor: '#667eea', borderWidth: 1.5, borderDash: [5, 5], pointRadius: 0 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { r: { min: 0, max: 100 } } } });
                }
            }

            document.getElementById('printActions').style.display = 'block';
        }

        if (!reportId) {
            container.className = 'error';
            container.innerHTML = '<p>ç¼ºå°‘å‚æ•° report_idï¼Œè¯·ä»æŠ¥å‘Šé¡µç‚¹å‡»ã€Œå¯¼å‡º PDFã€æ‰“å¼€ã€‚</p>';
            return;
        }

        var userId = getCurrentUserId();
        if (!userId) {
            container.className = 'error';
            container.innerHTML = '<p>è¯·å…ˆç™»å½•åå†æŸ¥çœ‹æŠ¥å‘Šã€‚</p>';
            return;
        }

        getAssessmentReport(userId, reportId).then(function(result) {
            if (!result.success) {
                container.className = 'error';
                container.innerHTML = '<p>åŠ è½½å¤±è´¥ï¼š' + (result.msg || 'è¯·é‡è¯•') + '</p>';
                return;
            }
            if (result.data.status !== 'completed') {
                container.className = 'error';
                container.innerHTML = '<p>æŠ¥å‘Šå°šæœªç”Ÿæˆå®Œæˆï¼Œè¯·ç¨åå†è¯•ã€‚</p>';
                return;
            }
            container.classList.remove('loading');
            renderReport(result.data);
        }).catch(function(err) {
            container.className = 'error';
            container.innerHTML = '<p>åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚</p>';
        });

        async function exportPDF() {
            var el = document.getElementById('report-content');
            if (!el) return;
            try {
                btnPrint.disabled = true;
                btnPrint.textContent = 'å¯¼å‡ºä¸­...';
                var canvas = await html2canvas(el, { scale: 2, useCORS: true });
                var imgData = canvas.toDataURL('image/jpeg', 0.95);
                var jsPDF = window.jspdf && window.jspdf.jsPDF;
                if (!jsPDF) { throw new Error('jsPDF æœªåŠ è½½'); }
                var pdf = new jsPDF('p', 'mm', 'a4');
                var pdfW = pdf.internal.pageSize.getWidth();
                var pdfH = (canvas.height * pdfW) / canvas.width;
                pdf.addImage(imgData, 'JPEG', 0, 0, pdfW, pdfH);
                pdf.save('èŒä¸šæµ‹è¯„æŠ¥å‘Š.pdf');
            } catch (e) {
                console.error(e);
                btnPrint.textContent = 'å¯¼å‡ºå¤±è´¥ï¼Œè¯·é‡è¯•';
            } finally {
                btnPrint.disabled = false;
                btnPrint.textContent = 'å¯¼å‡º PDF';
            }
        }

        btnPrint.addEventListener('click', function() {
            exportPDF();
        });
})();
    </script>
</body>
</html>
