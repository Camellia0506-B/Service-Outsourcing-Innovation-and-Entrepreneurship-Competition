# PDF 文档阅读智能体 - 运行说明

## 环境要求

- Python 3.8 或更高版本
- pip 包管理器

## 安装步骤

### 1. 安装依赖

进入 `pdf_agent` 目录，安装所需的 Python 包：

```bash
cd pdf_agent
pip install -r requirements.txt
```

### 2. 配置环境变量

设置 doubao-seed-1.6 API 的密钥：

**Windows (PowerShell):**

```powershell
$env:ARK_API_KEY="your-api-key-here"
```

**Windows (CMD):**

```cmd
set ARK_API_KEY=your-api-key-here
```

**Linux/Mac:**

```bash
export ARK_API_KEY="your-api-key-here"
```

**或者创建 `.env` 文件（推荐）：**

在 `pdf_agent` 目录下创建 `.env` 文件：

```env
ARK_API_KEY=your-api-key-here
DOUBAO_MODEL=doubao-seed-1-6-251015
PORT=8000
HOST=0.0.0.0
```

然后安装 `python-dotenv` 并在代码中加载（可选，当前版本需要手动设置环境变量）。

### 3. 运行服务

**方式一：直接运行**

```bash
python main.py
```

**方式二：使用 uvicorn（推荐）**

```bash
uvicorn main:app --host 0.0.0.0 --port 8000 --reload
```

`--reload` 参数表示开发模式，代码修改后自动重启。

### 4. 验证服务

打开浏览器访问：`http://localhost:8000/`

应该看到：

```json
{
  "code": 200,
  "msg": "PDF 文档阅读智能体服务运行正常"
}
```

## 配置说明

### 环境变量

| 变量名         | 说明                     | 必填 | 默认值                   |
| -------------- | ------------------------ | ---- | ------------------------ |
| `ARK_API_KEY`  | doubao-seed-1.6 API 密钥 | 是   | 无                       |
| `DOUBAO_MODEL` | 模型接入点 ID            | 否   | `doubao-seed-1-6-251015` |
| `PORT`         | 服务端口                 | 否   | `8000`                   |
| `HOST`         | 服务主机                 | 否   | `0.0.0.0`                |

### 端口配置

默认端口为 `8000`，如果端口被占用，可以通过环境变量修改：

```bash
# Windows
$env:PORT=8080
python main.py

# Linux/Mac
export PORT=8080
python main.py
```

## 测试接口

### 使用 curl 测试

**1. 健康检查：**

```bash
curl http://localhost:8000/
```

**2. 上传 PDF：**

```bash
curl -X POST "http://localhost:8000/api/v1/pdf/upload" \
  -F "file=@test.pdf"
```

**3. 提问（替换 session_id）：**

```bash
curl -X POST "http://localhost:8000/api/v1/pdf/chat" \
  -H "Content-Type: application/json" \
  -d '{
    "session_id": "your-session-id-here",
    "question": "这个文档的主要内容是什么？"
  }'
```

### 使用 Python 测试

创建 `test_client.py`：

```python
import requests

# 1. 上传 PDF
with open('test.pdf', 'rb') as f:
    files = {'file': f}
    response = requests.post('http://localhost:8000/api/v1/pdf/upload', files=files)
    result = response.json()
    print("上传结果:", result)

    if result['code'] == 200:
        session_id = result['data']['session_id']

        # 2. 提问
        chat_response = requests.post(
            'http://localhost:8000/api/v1/pdf/chat',
            json={
                'session_id': session_id,
                'question': '这个文档的主要内容是什么？'
            }
        )
        chat_result = chat_response.json()
        print("回答:", chat_result)
```

运行：

```bash
python test_client.py
```

## 常见问题

### 1. 导入错误

**问题：** `ModuleNotFoundError: No module named 'fitz'`

**解决：** PyMuPDF 的导入名是 `fitz`，但包名是 `PyMuPDF`。确保已安装：

```bash
pip install PyMuPDF
```

### 2. API Key 错误

**问题：** `ValueError: 请设置环境变量 ARK_API_KEY`

**解决：** 确保已正确设置环境变量：

```bash
# 检查环境变量
echo $ARK_API_KEY  # Linux/Mac
echo %ARK_API_KEY%  # Windows CMD
$env:ARK_API_KEY  # Windows PowerShell
```

### 3. 端口被占用

**问题：** `Address already in use`

**解决：**

- 修改端口：`$env:PORT=8080`
- 或关闭占用 8000 端口的程序

### 4. PDF 处理失败

**问题：** `PDF 处理失败: ...`

**解决：**

- 确保 PDF 文件完整且未损坏
- 检查文件权限
- 尝试使用其他 PDF 文件测试

### 5. 内存占用过高

**问题：** 处理大型 PDF 时内存占用过高

**解决：**

- 当前实现会将所有页面图像保存在内存中
- 对于大型 PDF，建议：
  - 限制 PDF 页数
  - 使用持久化存储（Redis/数据库）
  - 定期清理会话

## 生产环境部署

### 使用 Gunicorn（Linux/Mac）

```bash
pip install gunicorn
gunicorn -w 4 -k uvicorn.workers.UvicornWorker main:app --bind 0.0.0.0:8000
```

### 使用 Docker

创建 `Dockerfile`：

```dockerfile
FROM python:3.9-slim

WORKDIR /app

COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

COPY . .

ENV PORT=8000
ENV HOST=0.0.0.0

CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000"]
```

构建和运行：

```bash
docker build -t pdf-agent .
docker run -p 8000:8000 -e ARK_API_KEY=your-key pdf-agent
```

### 使用 systemd（Linux）

创建 `/etc/systemd/system/pdf-agent.service`：

```ini
[Unit]
Description=PDF Agent Service
After=network.target

[Service]
Type=simple
User=your-user
WorkingDirectory=/path/to/pdf_agent
Environment="ARK_API_KEY=your-key"
ExecStart=/usr/bin/python3 main.py
Restart=always

[Install]
WantedBy=multi-user.target
```

启动服务：

```bash
sudo systemctl start pdf-agent
sudo systemctl enable pdf-agent
```

## 性能优化建议

1. **会话存储：** 使用 Redis 替代内存存储，支持分布式部署
2. **图像缓存：** 对 PDF 图像进行缓存，避免重复处理
3. **异步处理：** 对于大型 PDF，使用异步任务队列（Celery）
4. **限流：** 添加请求频率限制，防止滥用
5. **文件大小限制：** 限制上传文件大小，避免内存溢出

## 日志配置

当前版本使用默认日志。可以添加日志配置：

```python
import logging

logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler('pdf_agent.log'),
        logging.StreamHandler()
    ]
)
```

## 安全建议

1. **CORS 配置：** 生产环境应限制允许的源
2. **API 密钥：** 使用密钥管理服务（如 AWS Secrets Manager）
3. **文件验证：** 添加文件大小和类型验证
4. **HTTPS：** 使用 HTTPS 加密传输
5. **认证：** 添加 API 认证机制

## 技术支持

如遇到问题，请检查：

1. Python 版本是否符合要求
2. 所有依赖是否已正确安装
3. 环境变量是否已设置
4. API Key 是否有效
5. 网络连接是否正常

## 更新日志

### v1.0.0

- 初始版本
- 支持 PDF 上传和对话
- 集成 doubao-seed-1.6 API
