{"ast":null,"code":"import \"core-js/modules/es.array.push.js\";\nimport \"core-js/modules/es.iterator.constructor.js\";\nimport \"core-js/modules/es.iterator.filter.js\";\nimport \"core-js/modules/es.iterator.find.js\";\nimport { ref, computed, nextTick, watch, onMounted, onBeforeUnmount, reactive } from 'vue';\nimport { uploadPdfAPI, clearPdfSessionAPI, chatPdfStreamAPI } from '@/api/pdf';\n// import { debugStreamSSE } from '@/utils/sseDebug'\n\n// å“åº”å¼æ•°æ®\nimport md from '@/utils/markdown';\nimport DOMPurify from 'dompurify';\nexport default {\n  __name: 'AI',\n  setup(__props, {\n    expose: __expose\n  }) {\n    __expose();\n    const messages = ref([]);\n    const inputMessage = ref('');\n    const uploadedFiles = ref([]);\n    const isLoading = ref(false);\n    const isDragging = ref(false);\n    const sessionId = ref(null);\n    const pdfInfo = ref(null);\n\n    // DOMå¼•ç”¨\n    const chatContainer = ref(null);\n    const fileInput = ref(null);\n    const streamAborter = ref(null); // AbortController\n    const waitingFirstToken = ref(false);\n    const genId = () => `${Date.now()}_${Math.random().toString(16).slice(2)}`;\n    const findMsgById = id => messages.value.find(m => m?.id === id);\n    const PG_SYSTEM_PROMPT = `\nä½ æ˜¯ã€Œä¿ç ”/æ¨å…ç”³è¯·ã€æ–¹å‘çš„æ–‡ä¹¦ä¸ææ–™ä¼˜åŒ–åŠ©æ‰‹ï¼Œè€Œä¸æ˜¯å°±ä¸šæ±‚èŒç®€å†é¡¾é—®ã€‚\nè¯·å§‹ç»ˆä»¥\"ä¿ç ”/å¤ä»¤è¥/é¢„æ¨å…/ä¹æ¨/å¯¼å¸ˆå¥—ç£/ç§‘ç ”ç»å†å±•ç¤º/å­¦æœ¯èƒ½åŠ›è¯æ˜\"ä¸ºæ ¸å¿ƒç›®æ ‡æ¥åˆ†æä¸å»ºè®®ã€‚\n\nã€å¿…é¡»éµå®ˆã€‘\n1) ä¸è¦æŠŠé‡ç‚¹æ”¾åœ¨\"æ‰¾å·¥ä½œ/ä¼ä¸šæ‹›è˜/å¤§å‚å®ä¹ /HRç­›é€‰/é¢è¯•æŠ€å·§/å²—ä½åŒ¹é…\"ç­‰å°±ä¸šè¯­å¢ƒä¸Šï¼Œé™¤éç”¨æˆ·æ˜ç¡®è¦æ±‚ã€‚\n2) è¾“å‡ºå†…å®¹ä¼˜å…ˆæœåŠ¡ï¼šä¿ç ”ç®€å†ï¼ˆå­¦æœ¯ç‰ˆï¼‰ã€ä¸ªäººé™ˆè¿°/è‡ªè¿°ã€å¥—ç£ä¿¡ã€ç§‘ç ”/ç«èµ›ç»å†è¡¨è¿°ã€æ¨èä¿¡ç´ æã€PPTæ±‡æŠ¥ï¼ˆå­¦æœ¯æ±‡æŠ¥/é¢è¯•ï¼‰ç­‰ã€‚\n3) è‹¥ç”¨æˆ·é—®é¢˜æ¨¡ç³Šï¼Œè¯·ä½ å…ˆé»˜è®¤æŒ‰\"ä¿ç ”ææ–™ä¼˜åŒ–\"æ¥å›ç­”ï¼Œå¹¶åœ¨å¼€å¤´ç”¨ä¸€å¥è¯è¯´æ˜ä½ çš„ä¿ç ”è§†è§’ã€‚\n4) å»ºè®®å°½é‡\"å¯è½åœ°\"ï¼šç»™å¯ç›´æ¥æ›¿æ¢çš„è¡¨è¿°æ¨¡æ¿ã€è¦ç‚¹åˆ—è¡¨ã€å¯é‡åŒ–æŒ‡æ ‡ï¼ˆè®ºæ–‡/é¡¹ç›®/æ¯”èµ›/æ’å/å¥–å­¦é‡‘/ç§‘ç ”äº§å‡ºç­‰ï¼‰ã€‚\n5) è¯­è¨€é£æ ¼ï¼šå­¦æœ¯ç”³è¯·åœºæ™¯ï¼Œå¼ºè°ƒåŠ¨æœºã€æ–¹æ³•ã€è´¡çŒ®ã€ç»“æœã€å¤ç°ã€å½±å“åŠ›ï¼›é¿å…HRè¯æœ¯ã€‚\n\nã€è¾“å‡ºç»“æ„å»ºè®®ã€‘\n- ç»“è®º/å®šä½ï¼ˆ1-2å¥ï¼‰\n- äº®ç‚¹ï¼ˆä¿ç ”å‘ï¼‰\n- é£é™©ç‚¹/çŸ­æ¿ï¼ˆä¿ç ”å‘ï¼‰\n- å¯ç›´æ¥æ”¹å†™çš„ç¤ºä¾‹ï¼ˆç»™å‡º1-3æ®µå¯å¤åˆ¶æ–‡æ¡ˆï¼‰\n- ä¸‹ä¸€æ­¥è¡¥å……ææ–™æ¸…å•ï¼ˆå¦‚éœ€è¦ï¼‰\n`.trim();\n\n    // âœ… ç”¨æˆ·é€‰æ‹©çš„ææ–™ç±»å‹ï¼šresume / ppt / email / script / mock\n    const docType = ref('resume');\n\n    // âœ… ææ–™ç±»å‹é€‰é¡¹ï¼ˆç”¨äºUIå±•ç¤ºï¼‰\n    const DOC_TYPE_OPTIONS = [{\n      value: 'resume',\n      label: 'ç®€å†ï¼ˆå­¦æœ¯ç‰ˆï¼‰'\n    }, {\n      value: 'ppt',\n      label: 'é¢è¯•PPT'\n    }, {\n      value: 'email',\n      label: 'è”ç³»å¯¼å¸ˆé‚®ä»¶ï¼ˆå¥—ç£ï¼‰'\n    }, {\n      value: 'script',\n      label: 'é¢è¯•æ–‡å­—ç¨¿ï¼ˆè‡ªæˆ‘ä»‹ç»/å›ç­”ï¼‰'\n    }, {\n      value: 'mock',\n      label: 'æ¨¡æ‹Ÿæé—®ï¼ˆé¢è¯•å®˜Q&Aï¼‰'\n    }];\n\n    // âœ… äº”ç±»ä¸“é¡¹æç¤ºè¯ï¼šçŸ­ã€ç‹ ã€å¯æ§ï¼ˆå»ºè®®åˆ«å¤ªé•¿ï¼Œé¿å…å tokenï¼‰\n    const TYPE_PROMPTS = {\n      resume: `\nä½ æ­£åœ¨ä¼˜åŒ–çš„æ˜¯ã€ä¿ç ”å­¦æœ¯ç®€å†ã€‘ï¼ˆéå°±ä¸šç®€å†ï¼‰ã€‚\nå…³æ³¨ï¼šç§‘ç ”/é¡¹ç›®/è®ºæ–‡/ç«èµ›/æ’å/è¯¾ç¨‹/æŠ€èƒ½/å¥–é¡¹çš„å­¦æœ¯å«é‡‘é‡ä¸å¯éªŒè¯æ€§ã€‚\nå¿…é¡»è¾“å‡ºï¼š\n1) ä¸€å¥è¯å®šä½ï¼ˆç ”ç©¶æ–¹å‘+ä¼˜åŠ¿è¯æ®ï¼‰\n2) äº®ç‚¹æ¡ç›®ï¼ˆç”¨\"åŠ¨ä½œ+æ–¹æ³•+ç»“æœ+é‡åŒ–\"å†™æ³•ï¼Œæ¯æ¡â‰¤2è¡Œï¼‰\n3) é£é™©ç‚¹ï¼ˆä¿ç ”è§†è§’ï¼šç§‘ç ”æ·±åº¦ã€æ–¹å‘åŒ¹é…ã€äº§å‡ºå¯ä¿¡åº¦ï¼‰\n4) ç»™å‡ºå¯ç›´æ¥æ›¿æ¢çš„ç®€å†æ¡ç›®æ”¹å†™ï¼ˆè‡³å°‘3æ¡ï¼‰\né¿å…ï¼šHRè¯æœ¯ã€å²—ä½åŒ¹é…ã€ä¼ä¸šå®ä¹ ä¼˜å…ˆçº§ï¼ˆé™¤éç”¨æˆ·è¦æ±‚ï¼‰ã€‚\n`.trim(),\n      ppt: `\nä½ æ­£åœ¨ä¼˜åŒ–çš„æ˜¯ã€ä¿ç ”é¢è¯•PPTã€‘ï¼ˆå­¦æœ¯æ±‡æŠ¥/é¢è¯•å±•ç¤ºï¼‰ã€‚\nå…³æ³¨ï¼šç»“æ„æ¸…æ™°ã€ç ”ç©¶åŠ¨æœºã€æ–¹æ³•è·¯çº¿ã€å®éªŒç»“æœã€è´¡çŒ®ã€æœªæ¥è®¡åˆ’ã€ä¸å¯¼å¸ˆæ–¹å‘åŒ¹é…ã€‚\nå¿…é¡»è¾“å‡ºï¼š\n1) æ¨èPPTç›®å½•ï¼ˆ8-12é¡µçš„é¡µæ ‡é¢˜ï¼‰\n2) æ¯é¡µè¦ç‚¹ï¼ˆæ¯é¡µ3-5ä¸ªbulletï¼Œè®²ä»€ä¹ˆã€æ€ä¹ˆè®²ï¼‰\n3) 2-3ä¸ª\"æœ€å®¹æ˜“è¢«è¿½é—®\"çš„ç‚¹ + é˜²å®ˆè¯æœ¯\n4) å¯ç›´æ¥ç”¨çš„\"å¼€åœº/æ”¶å°¾\"è®²ç¨¿å„1æ®µ\né¿å…ï¼šå•†åŠ¡æ±‡æŠ¥é£ã€æ±‚èŒæ±‡æŠ¥å¥—è·¯ã€‚\n`.trim(),\n      email: `\nä½ æ­£åœ¨ä¼˜åŒ–çš„æ˜¯ã€è”ç³»å¯¼å¸ˆå¥—ç£é‚®ä»¶ã€‘ï¼ˆä¸æ˜¯æ±‚èŒé‚®ä»¶ï¼‰ã€‚\nå…³æ³¨ï¼šç¤¼è²Œç®€æ´ã€èƒŒæ™¯åŒ¹é…ã€ç ”ç©¶å…´è¶£ã€ä½ èƒ½æä¾›çš„ä»·å€¼ã€å¯éªŒè¯ææ–™ã€æ˜ç¡®è¯‰æ±‚ã€‚\nå¿…é¡»è¾“å‡ºï¼š\n1) é‚®ä»¶ä¸»é¢˜ï¼ˆç»™2-3ä¸ªå¤‡é€‰ï¼‰\n2) é‚®ä»¶æ­£æ–‡ï¼ˆä¸­æ–‡/è‹±æ–‡æŒ‰ç”¨æˆ·è¯­è¨€ï¼›é»˜è®¤ä¸­æ–‡ï¼Œå¯é™„è‹±æ–‡ç‰ˆæœ¬ï¼‰\n3) ç»“æ„ï¼šé—®å€™-è‡ªæˆ‘ä»‹ç»-ç ”ç©¶åŒ¹é…-ä½ åšè¿‡ä»€ä¹ˆ-æƒ³è¦ä»€ä¹ˆ-é™„ä»¶/é“¾æ¥-è‡´è°¢\n4) ç»™å‡º\"å¯æ›¿æ¢å˜é‡ä½\"ï¼ˆå¯¼å¸ˆè¯¾é¢˜/ä½ é¡¹ç›®/è®ºæ–‡/é“¾æ¥ï¼‰\né¿å…ï¼šå¤¸å¼ å¹æ§ã€é•¿ç¯‡æµæ°´è´¦ã€æŠŠå¯¼å¸ˆå½“HRã€‚\n`.trim(),\n      script: `\nä½ æ­£åœ¨ä¼˜åŒ–çš„æ˜¯ã€é¢è¯•æ–‡å­—ç¨¿ã€‘ï¼ˆè‡ªæˆ‘ä»‹ç»/é¡¹ç›®è®²è§£/å¸¸è§é—®é¢˜å›ç­”ï¼‰ã€‚\nå…³æ³¨ï¼š1åˆ†é’Ÿ/3åˆ†é’Ÿä¸¤ç‰ˆï¼Œè‡ªæ´½ã€å¯è¿½é—®ã€å¯è½åœ°ã€‚\nå¿…é¡»è¾“å‡ºï¼š\n1) 1åˆ†é’Ÿè‡ªæˆ‘ä»‹ç»ç¨¿ + 3åˆ†é’Ÿè‡ªæˆ‘ä»‹ç»ç¨¿\n2) é¡¹ç›®è®²è§£æ¨¡æ¿ï¼šèƒŒæ™¯-ç›®æ ‡-æ–¹æ³•-ä½ çš„è´¡çŒ®-ç»“æœ-ä¸è¶³ä¸æ”¹è¿›ï¼ˆæ¯æ®µç»™ç¤ºä¾‹å¥ï¼‰\n3) 3ä¸ªé«˜é¢‘è¿½é—®ç‚¹ + å‚è€ƒå›ç­”ï¼ˆç®€æ´æœ‰è¯æ®ï¼‰\né¿å…ï¼šç©ºæ³›å½¢å®¹è¯ã€æ²¡æœ‰è¯æ®çš„\"æˆ‘å¾ˆçƒ­çˆ±ç§‘ç ”\"ã€‚\n`.trim(),\n      mock: `\nä½ ç°åœ¨æ‰®æ¼”ã€é¢è¯•å®˜ã€‘ï¼Œä¸ºä¿ç ”/å¤ä»¤è¥è¿›è¡Œæ¨¡æ‹Ÿæé—®ä¸è¿½é—®ã€‚\nè§„åˆ™ï¼š\n1) å…ˆåŸºäºPDFå†…å®¹ç»™å‡ºï¼š10ä¸ªé—®é¢˜ï¼ˆç”±æµ…å…¥æ·±ï¼Œè¦†ç›–åŠ¨æœº/æ–¹å‘/é¡¹ç›®/ç§‘ç ”æ–¹æ³•/åŸºç¡€çŸ¥è¯†/æœªæ¥è®¡åˆ’ï¼‰\n2) æ¯ä¸ªé—®é¢˜ç»™\"è€ƒå¯Ÿç‚¹\"\n3) å†éšæœºæŒ‘3é¢˜è¿›è¡ŒäºŒæ¬¡è¿½é—®ï¼ˆæ›´å°–é”ã€æ›´ç»†èŠ‚ï¼‰\n4) æœ€åç»™\"å›ç­”å»ºè®®æ¡†æ¶\"ï¼ˆSTAR/ç§‘ç ”äº”æ®µå¼ç­‰ï¼‰\né¿å…ï¼šä¼ä¸šé¢è¯•é¢˜ã€å…«è‚¡æ±‚èŒé¢˜ï¼ˆé™¤éç”¨æˆ·è¦æ±‚ï¼‰ã€‚\n`.trim()\n    };\n    const showTypeModal = ref(false);\n    const typeConfirmed = ref(false);\n    const buildQuestion = userMsg => {\n      const typePrompt = TYPE_PROMPTS[docType.value] || '';\n      const typeLabel = DOC_TYPE_OPTIONS.find(x => x.value === docType.value)?.label || docType.value;\n      return `${PG_SYSTEM_PROMPT}\n\nã€ææ–™ç±»å‹ã€‘\n${typeLabel}\n\nã€è¯¥ç±»å‹ä¸“é¡¹è¦æ±‚ã€‘\n${typePrompt}\n\nã€ç”¨æˆ·é—®é¢˜ã€‘\n${userMsg}\n\nã€æ³¨æ„ã€‘\nè¯·ç»“åˆå·²ä¸Šä¼ PDFå†…å®¹ä½œç­”ï¼›é»˜è®¤æŒ‰ä¿ç ”/æ¨å…ç”³è¯·åœºæ™¯è¾“å‡ºï¼›ç»™å‡ºå¯ç›´æ¥å¤åˆ¶çš„ä¿®æ”¹ç¤ºä¾‹ã€‚`;\n    };\n    const normalizeMarkdown = (s = '') => s\n    // 1ï¸âƒ£ å»æ‰å…¨æ–‡ BOM / é›¶å®½å­—ç¬¦\n    .replace(/^\\uFEFF/, '').replace(/\\u200B/g, '')\n    // 2ï¸âƒ£ å…³é”®ï¼šå»æ‰â€œè¡Œé¦–æ‰€æœ‰ç©ºç™½ + #â€\n    .replace(/^[ \\t\\u3000]+(?=#{1,6}\\s*)/gm, '');\n    const renderMarkdown = text => {\n      const html = md.render(normalizeMarkdown(text || ''));\n      return DOMPurify.sanitize(html);\n    };\n    async function streamSSEPost({\n      url,\n      payload,\n      signal,\n      onEvent\n    }) {\n      // âœ… [DBG] å¼€å§‹æ—¶é—´\n      const t0 = performance.now();\n      console.log('[SSE][T0] start', url);\n      const resp = await fetch(url, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          Accept: 'text/event-stream'\n        },\n        body: JSON.stringify(payload),\n        signal\n      });\n\n      // âœ… [DBG] æ‹¿åˆ° headers\n      console.log('[SSE][T1] headers', (performance.now() - t0).toFixed(1), 'ms', 'status=', resp.status);\n      if (!resp.ok) throw new Error(`HTTP ${resp.status}`);\n      const reader = resp.body.getReader();\n      const decoder = new TextDecoder('utf-8');\n      let pending = '';\n      let curEvent = 'message';\n      let curDataLines = [];\n\n      // âœ… [DBG] ç¬¬ä¸€æ¬¡ chunk / ç¬¬ä¸€æ¬¡ emit\n      let firstChunkLogged = false;\n      let firstEmitLogged = false;\n      const emit = () => {\n        const data = curDataLines.join('\\n');\n        if (!firstEmitLogged) {\n          firstEmitLogged = true;\n          console.log('[SSE][T3] first emit', (performance.now() - t0).toFixed(1), 'ms', 'event=', curEvent, 'dataLen=', data.length);\n        }\n        onEvent?.({\n          event: curEvent,\n          data\n        });\n      };\n      while (true) {\n        const {\n          value,\n          done\n        } = await reader.read();\n        if (done) break;\n        if (!firstChunkLogged) {\n          firstChunkLogged = true;\n          console.log('[SSE][T2] first chunk', (performance.now() - t0).toFixed(1), 'ms', 'bytes=', value?.byteLength ?? 0);\n        }\n        pending += decoder.decode(value, {\n          stream: true\n        }).replace(/\\r\\n/g, '\\n');\n        let idx;\n        while ((idx = pending.indexOf('\\n\\n')) !== -1) {\n          const block = pending.slice(0, idx);\n          pending = pending.slice(idx + 2);\n          const lines = block.split('\\n');\n          curEvent = 'message';\n          curDataLines = [];\n          for (const line of lines) {\n            if (!line || line.startsWith(':')) continue;\n            if (line.startsWith('event:')) curEvent = line.slice(6).trim();else if (line.startsWith('data:')) curDataLines.push(line.slice(5));\n          }\n          emit();\n          if (curEvent === 'done' || curDataLines.join('\\n') === '[DONE]') {\n            try {\n              reader.cancel();\n            } catch {}\n            return;\n          }\n        }\n      }\n    }\n\n    // âœ… assistant å ä½ï¼šç”¨ reactive ä¿è¯åç»­ä¿®æ”¹èƒ½è§¦å‘è§†å›¾æ›´æ–°\n    const assistantId = genId();\n    // messages.value.push({\n    //     id: assistantId,\n    //     role: 'assistant',\n    //     content: '',\n    //     html: null,\n    //     streaming: true,\n    //     timestamp: new Date()\n    // })\n    // messages.value.push(assistantMsg)\n\n    // è®¡ç®—å±æ€§\n    const canSend = computed(() => {\n      return !isLoading.value && inputMessage.value.trim() && sessionId.value && typeConfirmed.value // âœ… å¿…é¡»å…ˆé€‰ç±»å‹\n      ;\n    });\n\n    // åˆå§‹åŒ–æ¬¢è¿æ¶ˆæ¯\n    onMounted(() => {\n      messages.value.push({\n        id: genId(),\n        role: 'assistant',\n        content: 'ä½ å¥½ï¼æˆ‘æ˜¯ã€Œä¿ç ”æ–‡ä¹¦AIåŠ©æ‰‹ã€ğŸ“„\\n\\næˆ‘å¯ä»¥å¸®ä½ é˜…è¯»å’Œæ‰“ç£¨ç®€å†/å¥—ç£ä¿¡/PPTå†…å®¹ï¼š\\n\\nâ€¢ ä¸Šä¼ PDFæ–‡ä»¶ï¼ˆæ”¯æŒæ‹–æ‹½ä¸Šä¼ ï¼‰\\n\\nâ€¢ è¯¢é—®æ–‡æ¡£ä¸­çš„ä»»ä½•å†…å®¹\\n\\nâ€¢ å¤šè½®å¯¹è¯ï¼Œè®°ä½ä¸Šä¸‹æ–‡\\n\\nâ€¢ æ™ºèƒ½æå–å…³é”®ä¿¡æ¯\\n\\nè¯·ä¸Šä¼ ä¸€ä»½PDFæ–‡ä»¶å¼€å§‹å§ï¼æ”¯æŒæœ€å¤š10é¡µçš„æ–‡æ¡£åˆ†æã€‚',\n        timestamp: new Date()\n      });\n    });\n\n    // ç›‘å¬æ¶ˆæ¯å˜åŒ–è‡ªåŠ¨æ»šåŠ¨ï¼ˆä»…é’ˆå¯¹æ–°æ¶ˆæ¯ï¼Œæµå¼æ—¶åœ¨ flush ä¸­å¤„ç†ï¼‰\n    watch(() => messages.value.length, () => {\n      nextTick(() => {\n        if (chatContainer.value) {\n          chatContainer.value.scrollTop = chatContainer.value.scrollHeight;\n        }\n      });\n    });\n\n    // ç»„ä»¶å¸è½½å‰æ¸…é™¤ä¼šè¯\n    onBeforeUnmount(() => {\n      // å–æ¶ˆæ­£åœ¨è¿›è¡Œçš„æµå¼è¯·æ±‚\n      try {\n        streamAborter.value?.abort?.();\n      } catch {}\n      clearSession();\n    });\n\n    // æ ¼å¼åŒ–æ—¶é—´\n    const formatTime = timestamp => {\n      const d = timestamp instanceof Date ? timestamp : new Date(timestamp);\n      const hours = d.getHours().toString().padStart(2, '0');\n      const minutes = d.getMinutes().toString().padStart(2, '0');\n      return `${hours}:${minutes}`;\n    };\n\n    // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°\n    const formatFileSize = bytes => {\n      if (bytes < 1024) return bytes + ' B';\n      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';\n      return (bytes / (1024 * 1024)).toFixed(1) + ' MB';\n    };\n\n    // æ¸…é™¤ä¼šè¯\n    const clearSession = async () => {\n      if (!sessionId.value) return;\n      try {\n        await clearPdfSessionAPI(sessionId.value);\n      } catch (error) {\n        console.error('æ¸…é™¤ä¼šè¯å¤±è´¥:', error);\n      }\n    };\n\n    // æ–‡ä»¶é€‰æ‹©å¤„ç†\n    const handleFileSelect = event => {\n      handleFileUpload(Array.from(event.target.files || []));\n      event.target.value = '';\n    };\n\n    // æ‹–æ‹½æ”¾ç½®å¤„ç†\n    const handleDrop = event => {\n      isDragging.value = false;\n      handleFileUpload(Array.from(event.dataTransfer.files || []));\n    };\n\n    // æ–‡ä»¶ä¸Šä¼ å¤„ç†ï¼ˆaxiosç‰ˆï¼‰\n    const handleFileUpload = async files => {\n      const validFiles = files.filter(file => {\n        if (!file.name.toLowerCase().endsWith('.pdf')) {\n          alert(`æ–‡ä»¶ \"${file.name}\" ä¸æ˜¯PDFæ ¼å¼`);\n          return false;\n        }\n        if (file.size > 10 * 1024 * 1024) {\n          alert(`æ–‡ä»¶ \"${file.name}\" è¶…è¿‡ 10MB é™åˆ¶`);\n          return false;\n        }\n        return true;\n      });\n      if (validFiles.length === 0) return;\n      const file = validFiles[0];\n\n      // å¦‚æœå·²æœ‰ä¼šè¯ï¼Œå…ˆæ¸…é™¤\n      if (sessionId.value) {\n        await clearSession();\n        sessionId.value = null;\n        pdfInfo.value = null;\n      }\n      isLoading.value = true;\n      try {\n        const formData = new FormData();\n        formData.append('file', file);\n        const body = await uploadPdfAPI(formData);\n        uploadedFiles.value = [{\n          name: file.name,\n          size: file.size,\n          file\n        }];\n        sessionId.value = body.data.session_id;\n        pdfInfo.value = body.data;\n        messages.value.push({\n          id: genId(),\n          role: 'assistant',\n          content: `âœ… PDFæ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼\\n\\næ–‡ä»¶åï¼š${body.data.filename}\\né¡µæ•°ï¼š${body.data.page_count} é¡µ\\n${body.data.page_count > 10 ? 'ï¼ˆå°†åˆ†æå‰10é¡µå†…å®¹ï¼‰\\n' : ''}\\nç°åœ¨ä½ å¯ä»¥å‘æˆ‘æé—®å…³äºè¿™ä»½æ–‡æ¡£çš„ä»»ä½•é—®é¢˜äº†ï¼`,\n          timestamp: new Date()\n        });\n\n        // âœ… ä¸Šä¼ åè¦æ±‚å…ˆé€‰æ‹©ææ–™ç±»å‹\n        showTypeModal.value = true;\n        typeConfirmed.value = false;\n        messages.value.push({\n          id: genId(),\n          role: 'assistant',\n          content: 'ğŸ“Œ è¯·å…ˆé€‰æ‹©è¿™ä»½PDFå±äºå“ªç§ææ–™ï¼š\\n\\n (1) ç®€å†  (2) é¢è¯•PPT  (3) å¥—ç£é‚®ä»¶  (4) é¢è¯•æ–‡å­—ç¨¿  (5) æ¨¡æ‹Ÿæé—® \\n\\né€‰æ‹©åæˆ‘ä¼šæŒ‰å¯¹åº”åœºæ™¯ç»™ä½ æ›´ç²¾å‡†çš„å»ºè®®ã€‚',\n          timestamp: new Date()\n        });\n      } catch (err) {\n        console.error('[upload err]', err);\n        messages.value.push({\n          id: genId(),\n          role: 'assistant',\n          content: `âŒ ä¸Šä¼ å¤±è´¥ï¼š${err.message || 'æœªçŸ¥é”™è¯¯'}`,\n          timestamp: new Date()\n        });\n      } finally {\n        isLoading.value = false;\n      }\n    };\n\n    // ç§»é™¤æ–‡ä»¶\n    const removeFile = async () => {\n      if (sessionId.value) {\n        await clearSession();\n        sessionId.value = null;\n        pdfInfo.value = null;\n      }\n      uploadedFiles.value = [];\n      messages.value.push({\n        id: genId(),\n        role: 'assistant',\n        content: 'æ–‡ä»¶å·²ç§»é™¤ï¼Œè¯·ä¸Šä¼ æ–°çš„PDFæ–‡ä»¶å¼€å§‹å¯¹è¯ã€‚',\n        timestamp: new Date()\n      });\n    };\n    const renderStreamingMarkdown = text => {\n      if (!text) return '';\n      return DOMPurify.sanitize(text\n      // æ¢è¡Œ\n      .replace(/\\n/g, '<br/>')\n      // åŠ ç²—\n      .replace(/\\*\\*(.+?)\\*\\*/g, '<strong>$1</strong>')\n      // åˆ—è¡¨\n      .replace(/^\\s*[-*]\\s+(.*)$/gm, 'â€¢ $1'));\n    };\n\n    // âœ… å‘é€æ¶ˆæ¯ï¼ˆæµå¼ç‰ˆ + rAF + æ‰“å­—æœºèŠ‚æµï¼‰\n    const handleSendMessage = async () => {\n      if (!canSend.value) return;\n      const userMsg = inputMessage.value.trim();\n      messages.value.push({\n        role: 'user',\n        content: userMsg,\n        timestamp: new Date()\n      });\n      inputMessage.value = '';\n      isLoading.value = true;\n\n      // âœ… assistant å ä½ï¼šå¿…é¡» reactive\n      const assistantMsg = reactive({\n        role: 'assistant',\n        content: '',\n        html: null,\n        streaming: true,\n        timestamp: new Date()\n      });\n      messages.value.push(assistantMsg);\n      waitingFirstToken.value = true;\n\n      // âœ… AbortController\n      const ac = new AbortController();\n      streamAborter.value = ac;\n\n      // ====== æ‰“å­—æœºå‚æ•°ï¼ˆä½ åªè°ƒè¿™ä¸¤ä¸ªï¼‰======\n      const CHUNK_CHARS = 4; // æ¯æ¬¡åå‡ ä¸ªå­—ï¼ˆå°=æ…¢ï¼‰\n      const TICK_MS = 60; // é—´éš” msï¼ˆå¤§=æ…¢ï¼‰\n      // ======================================\n\n      let queue = '';\n      let timer = null;\n      let ended = false;\n      const forceRerender = () => {\n        // âœ… å…³é”®ï¼šå¼ºåˆ¶ Vue è§¦å‘ä¸€æ¬¡ v-for çš„æ›´æ–°ï¼ˆè§£å†³ä½ ç°åœ¨çš„â€œæ°”æ³¡ç©ºç™½â€ï¼‰\n        messages.value = [...messages.value];\n      };\n      const startTyping = () => {\n        if (timer) return;\n        timer = setInterval(() => {\n          if (!queue) {\n            if (ended) {\n              clearInterval(timer);\n              timer = null;\n              assistantMsg.streaming = false;\n              assistantMsg.html = renderMarkdown(assistantMsg.content);\n              forceRerender();\n            }\n            return;\n          }\n          const take = queue.slice(0, CHUNK_CHARS);\n          queue = queue.slice(CHUNK_CHARS);\n          assistantMsg.content += take;\n          forceRerender();\n          nextTick(() => {\n            if (chatContainer.value) {\n              chatContainer.value.scrollTop = chatContainer.value.scrollHeight;\n            }\n          });\n        }, TICK_MS);\n      };\n      try {\n        await streamSSEPost({\n          url: '/api/pdf/chat/stream',\n          // èµ°ä½ å‰ç«¯ proxy çš„è·¯å¾„\n          payload: {\n            session_id: sessionId.value,\n            question: buildQuestion(userMsg)\n          },\n          signal: ac.signal,\n          onEvent: ({\n            event,\n            data\n          }) => {\n            if (event === 'token') {\n              // âœ… ç¬¬ä¸€ä¸ªâ€œéç©º tokenâ€åˆ°æ¥\n              if (waitingFirstToken.value && data && data.replace(/\\u200b/g, '').trim()) {\n                waitingFirstToken.value = false;\n                console.log('[UI][FIRST_TOKEN] got', performance.now().toFixed(1), 'ms', 'token=', data);\n                requestAnimationFrame(() => {\n                  console.log('[UI][PAINT] after first token', performance.now().toFixed(1), 'ms');\n                });\n              }\n              queue += data ?? '';\n              startTyping();\n            } else if (event === 'done' || data === '[DONE]') {\n              waitingFirstToken.value = false;\n              ended = true;\n            } else if (event === 'error') {\n              waitingFirstToken.value = false;\n              ended = true;\n              queue += `\\n\\nâŒ ${data || 'æµå¼å¼‚å¸¸'}`;\n              startTyping();\n            }\n          }\n        });\n        ended = true;\n      } catch (e) {\n        if (e?.name !== 'AbortError') {\n          ended = true;\n          queue += `\\n\\nâŒ æµå¼å¤±è´¥ï¼š${e?.message || e}`;\n          startTyping();\n        }\n      } finally {\n        isLoading.value = false;\n        streamAborter.value = null;\n      }\n    };\n    const __returned__ = {\n      messages,\n      inputMessage,\n      uploadedFiles,\n      isLoading,\n      isDragging,\n      sessionId,\n      pdfInfo,\n      chatContainer,\n      fileInput,\n      streamAborter,\n      waitingFirstToken,\n      genId,\n      findMsgById,\n      PG_SYSTEM_PROMPT,\n      docType,\n      DOC_TYPE_OPTIONS,\n      TYPE_PROMPTS,\n      showTypeModal,\n      typeConfirmed,\n      buildQuestion,\n      normalizeMarkdown,\n      renderMarkdown,\n      streamSSEPost,\n      assistantId,\n      canSend,\n      formatTime,\n      formatFileSize,\n      clearSession,\n      handleFileSelect,\n      handleDrop,\n      handleFileUpload,\n      removeFile,\n      renderStreamingMarkdown,\n      handleSendMessage,\n      ref,\n      computed,\n      nextTick,\n      watch,\n      onMounted,\n      onBeforeUnmount,\n      reactive,\n      get uploadPdfAPI() {\n        return uploadPdfAPI;\n      },\n      get clearPdfSessionAPI() {\n        return clearPdfSessionAPI;\n      },\n      get chatPdfStreamAPI() {\n        return chatPdfStreamAPI;\n      },\n      get md() {\n        return md;\n      },\n      get DOMPurify() {\n        return DOMPurify;\n      }\n    };\n    Object.defineProperty(__returned__, '__isScriptSetup', {\n      enumerable: false,\n      value: true\n    });\n    return __returned__;\n  }\n};","map":{"version":3,"names":["ref","computed","nextTick","watch","onMounted","onBeforeUnmount","reactive","uploadPdfAPI","clearPdfSessionAPI","chatPdfStreamAPI","md","DOMPurify","messages","inputMessage","uploadedFiles","isLoading","isDragging","sessionId","pdfInfo","chatContainer","fileInput","streamAborter","waitingFirstToken","genId","Date","now","Math","random","toString","slice","findMsgById","id","value","find","m","PG_SYSTEM_PROMPT","trim","docType","DOC_TYPE_OPTIONS","label","TYPE_PROMPTS","resume","ppt","email","script","mock","showTypeModal","typeConfirmed","buildQuestion","userMsg","typePrompt","typeLabel","x","normalizeMarkdown","s","replace","renderMarkdown","text","html","render","sanitize","streamSSEPost","url","payload","signal","onEvent","t0","performance","console","log","resp","fetch","method","headers","Accept","body","JSON","stringify","toFixed","status","ok","Error","reader","getReader","decoder","TextDecoder","pending","curEvent","curDataLines","firstChunkLogged","firstEmitLogged","emit","data","join","length","event","done","read","byteLength","decode","stream","idx","indexOf","block","lines","split","line","startsWith","push","cancel","assistantId","canSend","role","content","timestamp","scrollTop","scrollHeight","abort","clearSession","formatTime","d","hours","getHours","padStart","minutes","getMinutes","formatFileSize","bytes","error","handleFileSelect","handleFileUpload","Array","from","target","files","handleDrop","dataTransfer","validFiles","filter","file","name","toLowerCase","endsWith","alert","size","formData","FormData","append","session_id","filename","page_count","err","message","removeFile","renderStreamingMarkdown","handleSendMessage","assistantMsg","streaming","ac","AbortController","CHUNK_CHARS","TICK_MS","queue","timer","ended","forceRerender","startTyping","setInterval","clearInterval","take","question","requestAnimationFrame","e"],"sources":["D:/Projects/Service-Outsourcing-Innovation-and-Entrepreneurship-Competition/frontend/src/views/AI.vue"],"sourcesContent":["<template>\r\n    <div class=\"pdf-agent-page\">\r\n        <!-- èŠå¤©æ¶ˆæ¯åŒºåŸŸ -->\r\n        <div class=\"chat-container\" ref=\"chatContainer\">\r\n            <div\r\n                v-for=\"message in messages\"\r\n                :key=\"message.id\"\r\n                :class=\"['chat-message', message.role]\"\r\n            >\r\n                <div class=\"message-content\">\r\n                    <!-- âœ… æµå¼é˜¶æ®µï¼šçº¯æ–‡æœ¬æ˜¾ç¤º -->\r\n                    <div\r\n                        v-if=\"message.role === 'assistant' && message.streaming\"\r\n                        class=\"message-text assistant-streaming\"\r\n                    >\r\n                        <!-- âœ… é¦– token æœªåˆ°ï¼šæ˜¾ç¤ºç­‰å¾…åŠ¨ç”» -->\r\n                        <div v-if=\"waitingFirstToken\" class=\"typing-indicator\">\r\n                            <span></span><span></span><span></span>\r\n                        </div>\r\n\r\n                        <!-- âœ… å·²æœ‰ tokenï¼šå¼€å§‹æµå¼å†…å®¹ -->\r\n                        <div\r\n                            v-else\r\n                            v-html=\"renderStreamingMarkdown(message.content)\"\r\n                        />\r\n                    </div>\r\n\r\n                    <!-- âœ… éæµå¼ï¼šmarkdown æ¸²æŸ“ -->\r\n                    <div\r\n                        v-else\r\n                        class=\"message-text markdown-body assistant-markdown\"\r\n                        v-html=\"message.html ?? renderMarkdown(message.content)\"\r\n                    ></div>\r\n\r\n                    <div class=\"message-time\">\r\n                        {{ formatTime(message.timestamp) }}\r\n                    </div>\r\n                </div>\r\n            </div>\r\n\r\n            <!-- âœ… åŠ è½½çŠ¶æ€ï¼šä»…åœ¨æ²¡æœ‰æµå¼æ¶ˆæ¯æ—¶æ˜¾ç¤º -->\r\n            <div\r\n                v-if=\"isLoading && !messages[messages.length - 1]?.streaming\"\r\n                class=\"chat-message assistant\"\r\n            >\r\n                <div class=\"message-content\">\r\n                    <div class=\"typing-indicator\">\r\n                        <span></span>\r\n                        <span></span>\r\n                        <span></span>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        </div>\r\n\r\n        <!-- è¾“å…¥åŒºåŸŸ -->\r\n        <div class=\"input-section\">\r\n            <!-- å·²ä¸Šä¼ æ–‡ä»¶æ˜¾ç¤º -->\r\n            <div v-if=\"uploadedFiles.length > 0\" class=\"uploaded-files\">\r\n                <div\r\n                    v-for=\"(file, index) in uploadedFiles\"\r\n                    :key=\"index\"\r\n                    class=\"file-chip\"\r\n                >\r\n                    <span>ğŸ“ {{ file.name }}</span>\r\n                    <span class=\"file-size\"\r\n                        >({{ formatFileSize(file.size) }})</span\r\n                    >\r\n                    <span v-if=\"pdfInfo\" class=\"file-pages\"\r\n                        >ğŸ“„ {{ pdfInfo.page_count }}é¡µ</span\r\n                    >\r\n                    <span class=\"remove-btn\" @click=\"removeFile(index)\">Ã—</span>\r\n                </div>\r\n            </div>\r\n\r\n            <!-- è¾“å…¥æ¡† -->\r\n            <div\r\n                class=\"input-box\"\r\n                :class=\"{ 'drag-over': isDragging }\"\r\n                @dragover.prevent=\"isDragging = true\"\r\n                @dragleave.prevent=\"isDragging = false\"\r\n                @drop.prevent=\"handleDrop\"\r\n            >\r\n                <input\r\n                    ref=\"fileInput\"\r\n                    type=\"file\"\r\n                    accept=\".pdf\"\r\n                    @change=\"handleFileSelect\"\r\n                    style=\"display: none\"\r\n                />\r\n\r\n                <button\r\n                    class=\"icon-btn upload-btn\"\r\n                    @click=\"$refs.fileInput.click()\"\r\n                    title=\"ä¸Šä¼ PDFæ–‡ä»¶\"\r\n                >\r\n                    <svg\r\n                        width=\"20\"\r\n                        height=\"20\"\r\n                        viewBox=\"0 0 24 24\"\r\n                        fill=\"none\"\r\n                        stroke=\"currentColor\"\r\n                        stroke-width=\"2\"\r\n                    >\r\n                        <path\r\n                            d=\"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4\"\r\n                        ></path>\r\n                        <polyline points=\"17 8 12 3 7 8\"></polyline>\r\n                        <line x1=\"12\" y1=\"3\" x2=\"12\" y2=\"15\"></line>\r\n                    </svg>\r\n                </button>\r\n\r\n                <input\r\n                    v-model=\"inputMessage\"\r\n                    type=\"text\"\r\n                    class=\"text-input\"\r\n                    :placeholder=\"\r\n                        !sessionId\r\n                            ? 'è¯·å…ˆä¸Šä¼ PDFæ–‡ä»¶'\r\n                            : !typeConfirmed\r\n                            ? 'è¯·å…ˆé€‰æ‹©ææ–™ç±»å‹ï¼ˆç®€å†/é¢è¯•PPT/å¥—ç£é‚®ä»¶/é¢è¯•ç¨¿/æ¨¡æ‹Ÿæé—®ï¼‰'\r\n                            : 'å‘æˆ‘æé—®æ–‡æ¡£å†…å®¹...'\r\n                    \"\r\n                    :disabled=\"!sessionId || !typeConfirmed\"\r\n                    @keydown.enter=\"handleSendMessage\"\r\n                />\r\n\r\n                <button\r\n                    class=\"icon-btn send-btn\"\r\n                    :disabled=\"!canSend\"\r\n                    @click=\"handleSendMessage\"\r\n                    title=\"å‘é€æ¶ˆæ¯\"\r\n                >\r\n                    <svg\r\n                        width=\"20\"\r\n                        height=\"20\"\r\n                        viewBox=\"0 0 24 24\"\r\n                        fill=\"currentColor\"\r\n                    >\r\n                        <path d=\"M2.01 21L23 12 2.01 3 2 10l15 2-15 2z\"></path>\r\n                    </svg>\r\n                </button>\r\n            </div>\r\n\r\n            <div class=\"input-hint\">\r\n                æ”¯æŒPDFæ ¼å¼æ–‡æ¡£ï¼ˆâ‰¤10MBï¼‰ï½œæ‹–æ‹½ä¸Šä¼ æˆ–ç‚¹å‡»æŒ‰é’®ï½œåˆ†æå‰10é¡µå†…å®¹ï½œå¤šè½®å¯¹è¯è®°ä½ä¸Šä¸‹æ–‡\r\n            </div>\r\n        </div>\r\n\r\n        <!-- âœ… ææ–™ç±»å‹é€‰æ‹©å¼¹çª— -->\r\n        <div v-if=\"showTypeModal\" class=\"modal-mask\" @click.self=\"() => {}\">\r\n            <div class=\"modal-card\">\r\n                <div class=\"modal-title\">è¯·é€‰æ‹©ææ–™ç±»å‹</div>\r\n                <div class=\"modal-sub\">\r\n                    é€‰æ‹©åæˆ‘ä¼šæŒ‰å¯¹åº”\"ä¿ç ”åœºæ™¯\"è¾“å‡ºæ›´ç²¾å‡†çš„ç»“æ„ä¸æ¨¡æ¿ã€‚\r\n                </div>\r\n\r\n                <div class=\"type-grid\">\r\n                    <button\r\n                        v-for=\"opt in DOC_TYPE_OPTIONS\"\r\n                        :key=\"opt.value\"\r\n                        class=\"type-btn\"\r\n                        :class=\"{ active: docType === opt.value }\"\r\n                        @click=\"docType = opt.value\"\r\n                    >\r\n                        {{ opt.label }}\r\n                    </button>\r\n                </div>\r\n\r\n                <div class=\"modal-actions\">\r\n                    <button\r\n                        class=\"confirm-btn\"\r\n                        @click=\"\r\n                            () => {\r\n                                typeConfirmed = true\r\n                                showTypeModal = false\r\n                                messages.push({\r\n                                    role: 'assistant',\r\n                                    content: `âœ… å·²é€‰æ‹©ï¼š${\r\n                                        DOC_TYPE_OPTIONS.find(\r\n                                            x => x.value === docType\r\n                                        )?.label\r\n                                    }ã€‚\\nç°åœ¨å¯ä»¥å¼€å§‹æé—®äº†ï¼`,\r\n                                    timestamp: new Date()\r\n                                })\r\n                            }\r\n                        \"\r\n                    >\r\n                        ç¡®è®¤\r\n                    </button>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    </div>\r\n</template>\r\n\r\n<script setup>\r\nimport {\r\n    ref,\r\n    computed,\r\n    nextTick,\r\n    watch,\r\n    onMounted,\r\n    onBeforeUnmount,\r\n    reactive\r\n} from 'vue'\r\n\r\nimport { uploadPdfAPI, clearPdfSessionAPI, chatPdfStreamAPI } from '@/api/pdf'\r\n// import { debugStreamSSE } from '@/utils/sseDebug'\r\n\r\n// å“åº”å¼æ•°æ®\r\nconst messages = ref([])\r\nconst inputMessage = ref('')\r\nconst uploadedFiles = ref([])\r\nconst isLoading = ref(false)\r\nconst isDragging = ref(false)\r\nconst sessionId = ref(null)\r\nconst pdfInfo = ref(null)\r\n\r\n// DOMå¼•ç”¨\r\nconst chatContainer = ref(null)\r\nconst fileInput = ref(null)\r\nconst streamAborter = ref(null) // AbortController\r\nconst waitingFirstToken = ref(false)\r\n\r\nconst genId = () => `${Date.now()}_${Math.random().toString(16).slice(2)}`\r\nconst findMsgById = id => messages.value.find(m => m?.id === id)\r\n\r\nconst PG_SYSTEM_PROMPT = `\r\nä½ æ˜¯ã€Œä¿ç ”/æ¨å…ç”³è¯·ã€æ–¹å‘çš„æ–‡ä¹¦ä¸ææ–™ä¼˜åŒ–åŠ©æ‰‹ï¼Œè€Œä¸æ˜¯å°±ä¸šæ±‚èŒç®€å†é¡¾é—®ã€‚\r\nè¯·å§‹ç»ˆä»¥\"ä¿ç ”/å¤ä»¤è¥/é¢„æ¨å…/ä¹æ¨/å¯¼å¸ˆå¥—ç£/ç§‘ç ”ç»å†å±•ç¤º/å­¦æœ¯èƒ½åŠ›è¯æ˜\"ä¸ºæ ¸å¿ƒç›®æ ‡æ¥åˆ†æä¸å»ºè®®ã€‚\r\n\r\nã€å¿…é¡»éµå®ˆã€‘\r\n1) ä¸è¦æŠŠé‡ç‚¹æ”¾åœ¨\"æ‰¾å·¥ä½œ/ä¼ä¸šæ‹›è˜/å¤§å‚å®ä¹ /HRç­›é€‰/é¢è¯•æŠ€å·§/å²—ä½åŒ¹é…\"ç­‰å°±ä¸šè¯­å¢ƒä¸Šï¼Œé™¤éç”¨æˆ·æ˜ç¡®è¦æ±‚ã€‚\r\n2) è¾“å‡ºå†…å®¹ä¼˜å…ˆæœåŠ¡ï¼šä¿ç ”ç®€å†ï¼ˆå­¦æœ¯ç‰ˆï¼‰ã€ä¸ªäººé™ˆè¿°/è‡ªè¿°ã€å¥—ç£ä¿¡ã€ç§‘ç ”/ç«èµ›ç»å†è¡¨è¿°ã€æ¨èä¿¡ç´ æã€PPTæ±‡æŠ¥ï¼ˆå­¦æœ¯æ±‡æŠ¥/é¢è¯•ï¼‰ç­‰ã€‚\r\n3) è‹¥ç”¨æˆ·é—®é¢˜æ¨¡ç³Šï¼Œè¯·ä½ å…ˆé»˜è®¤æŒ‰\"ä¿ç ”ææ–™ä¼˜åŒ–\"æ¥å›ç­”ï¼Œå¹¶åœ¨å¼€å¤´ç”¨ä¸€å¥è¯è¯´æ˜ä½ çš„ä¿ç ”è§†è§’ã€‚\r\n4) å»ºè®®å°½é‡\"å¯è½åœ°\"ï¼šç»™å¯ç›´æ¥æ›¿æ¢çš„è¡¨è¿°æ¨¡æ¿ã€è¦ç‚¹åˆ—è¡¨ã€å¯é‡åŒ–æŒ‡æ ‡ï¼ˆè®ºæ–‡/é¡¹ç›®/æ¯”èµ›/æ’å/å¥–å­¦é‡‘/ç§‘ç ”äº§å‡ºç­‰ï¼‰ã€‚\r\n5) è¯­è¨€é£æ ¼ï¼šå­¦æœ¯ç”³è¯·åœºæ™¯ï¼Œå¼ºè°ƒåŠ¨æœºã€æ–¹æ³•ã€è´¡çŒ®ã€ç»“æœã€å¤ç°ã€å½±å“åŠ›ï¼›é¿å…HRè¯æœ¯ã€‚\r\n\r\nã€è¾“å‡ºç»“æ„å»ºè®®ã€‘\r\n- ç»“è®º/å®šä½ï¼ˆ1-2å¥ï¼‰\r\n- äº®ç‚¹ï¼ˆä¿ç ”å‘ï¼‰\r\n- é£é™©ç‚¹/çŸ­æ¿ï¼ˆä¿ç ”å‘ï¼‰\r\n- å¯ç›´æ¥æ”¹å†™çš„ç¤ºä¾‹ï¼ˆç»™å‡º1-3æ®µå¯å¤åˆ¶æ–‡æ¡ˆï¼‰\r\n- ä¸‹ä¸€æ­¥è¡¥å……ææ–™æ¸…å•ï¼ˆå¦‚éœ€è¦ï¼‰\r\n`.trim()\r\n\r\n// âœ… ç”¨æˆ·é€‰æ‹©çš„ææ–™ç±»å‹ï¼šresume / ppt / email / script / mock\r\nconst docType = ref('resume')\r\n\r\n// âœ… ææ–™ç±»å‹é€‰é¡¹ï¼ˆç”¨äºUIå±•ç¤ºï¼‰\r\nconst DOC_TYPE_OPTIONS = [\r\n    { value: 'resume', label: 'ç®€å†ï¼ˆå­¦æœ¯ç‰ˆï¼‰' },\r\n    { value: 'ppt', label: 'é¢è¯•PPT' },\r\n    { value: 'email', label: 'è”ç³»å¯¼å¸ˆé‚®ä»¶ï¼ˆå¥—ç£ï¼‰' },\r\n    { value: 'script', label: 'é¢è¯•æ–‡å­—ç¨¿ï¼ˆè‡ªæˆ‘ä»‹ç»/å›ç­”ï¼‰' },\r\n    { value: 'mock', label: 'æ¨¡æ‹Ÿæé—®ï¼ˆé¢è¯•å®˜Q&Aï¼‰' }\r\n]\r\n\r\n// âœ… äº”ç±»ä¸“é¡¹æç¤ºè¯ï¼šçŸ­ã€ç‹ ã€å¯æ§ï¼ˆå»ºè®®åˆ«å¤ªé•¿ï¼Œé¿å…å tokenï¼‰\r\nconst TYPE_PROMPTS = {\r\n    resume: `\r\nä½ æ­£åœ¨ä¼˜åŒ–çš„æ˜¯ã€ä¿ç ”å­¦æœ¯ç®€å†ã€‘ï¼ˆéå°±ä¸šç®€å†ï¼‰ã€‚\r\nå…³æ³¨ï¼šç§‘ç ”/é¡¹ç›®/è®ºæ–‡/ç«èµ›/æ’å/è¯¾ç¨‹/æŠ€èƒ½/å¥–é¡¹çš„å­¦æœ¯å«é‡‘é‡ä¸å¯éªŒè¯æ€§ã€‚\r\nå¿…é¡»è¾“å‡ºï¼š\r\n1) ä¸€å¥è¯å®šä½ï¼ˆç ”ç©¶æ–¹å‘+ä¼˜åŠ¿è¯æ®ï¼‰\r\n2) äº®ç‚¹æ¡ç›®ï¼ˆç”¨\"åŠ¨ä½œ+æ–¹æ³•+ç»“æœ+é‡åŒ–\"å†™æ³•ï¼Œæ¯æ¡â‰¤2è¡Œï¼‰\r\n3) é£é™©ç‚¹ï¼ˆä¿ç ”è§†è§’ï¼šç§‘ç ”æ·±åº¦ã€æ–¹å‘åŒ¹é…ã€äº§å‡ºå¯ä¿¡åº¦ï¼‰\r\n4) ç»™å‡ºå¯ç›´æ¥æ›¿æ¢çš„ç®€å†æ¡ç›®æ”¹å†™ï¼ˆè‡³å°‘3æ¡ï¼‰\r\né¿å…ï¼šHRè¯æœ¯ã€å²—ä½åŒ¹é…ã€ä¼ä¸šå®ä¹ ä¼˜å…ˆçº§ï¼ˆé™¤éç”¨æˆ·è¦æ±‚ï¼‰ã€‚\r\n`.trim(),\r\n\r\n    ppt: `\r\nä½ æ­£åœ¨ä¼˜åŒ–çš„æ˜¯ã€ä¿ç ”é¢è¯•PPTã€‘ï¼ˆå­¦æœ¯æ±‡æŠ¥/é¢è¯•å±•ç¤ºï¼‰ã€‚\r\nå…³æ³¨ï¼šç»“æ„æ¸…æ™°ã€ç ”ç©¶åŠ¨æœºã€æ–¹æ³•è·¯çº¿ã€å®éªŒç»“æœã€è´¡çŒ®ã€æœªæ¥è®¡åˆ’ã€ä¸å¯¼å¸ˆæ–¹å‘åŒ¹é…ã€‚\r\nå¿…é¡»è¾“å‡ºï¼š\r\n1) æ¨èPPTç›®å½•ï¼ˆ8-12é¡µçš„é¡µæ ‡é¢˜ï¼‰\r\n2) æ¯é¡µè¦ç‚¹ï¼ˆæ¯é¡µ3-5ä¸ªbulletï¼Œè®²ä»€ä¹ˆã€æ€ä¹ˆè®²ï¼‰\r\n3) 2-3ä¸ª\"æœ€å®¹æ˜“è¢«è¿½é—®\"çš„ç‚¹ + é˜²å®ˆè¯æœ¯\r\n4) å¯ç›´æ¥ç”¨çš„\"å¼€åœº/æ”¶å°¾\"è®²ç¨¿å„1æ®µ\r\né¿å…ï¼šå•†åŠ¡æ±‡æŠ¥é£ã€æ±‚èŒæ±‡æŠ¥å¥—è·¯ã€‚\r\n`.trim(),\r\n\r\n    email: `\r\nä½ æ­£åœ¨ä¼˜åŒ–çš„æ˜¯ã€è”ç³»å¯¼å¸ˆå¥—ç£é‚®ä»¶ã€‘ï¼ˆä¸æ˜¯æ±‚èŒé‚®ä»¶ï¼‰ã€‚\r\nå…³æ³¨ï¼šç¤¼è²Œç®€æ´ã€èƒŒæ™¯åŒ¹é…ã€ç ”ç©¶å…´è¶£ã€ä½ èƒ½æä¾›çš„ä»·å€¼ã€å¯éªŒè¯ææ–™ã€æ˜ç¡®è¯‰æ±‚ã€‚\r\nå¿…é¡»è¾“å‡ºï¼š\r\n1) é‚®ä»¶ä¸»é¢˜ï¼ˆç»™2-3ä¸ªå¤‡é€‰ï¼‰\r\n2) é‚®ä»¶æ­£æ–‡ï¼ˆä¸­æ–‡/è‹±æ–‡æŒ‰ç”¨æˆ·è¯­è¨€ï¼›é»˜è®¤ä¸­æ–‡ï¼Œå¯é™„è‹±æ–‡ç‰ˆæœ¬ï¼‰\r\n3) ç»“æ„ï¼šé—®å€™-è‡ªæˆ‘ä»‹ç»-ç ”ç©¶åŒ¹é…-ä½ åšè¿‡ä»€ä¹ˆ-æƒ³è¦ä»€ä¹ˆ-é™„ä»¶/é“¾æ¥-è‡´è°¢\r\n4) ç»™å‡º\"å¯æ›¿æ¢å˜é‡ä½\"ï¼ˆå¯¼å¸ˆè¯¾é¢˜/ä½ é¡¹ç›®/è®ºæ–‡/é“¾æ¥ï¼‰\r\né¿å…ï¼šå¤¸å¼ å¹æ§ã€é•¿ç¯‡æµæ°´è´¦ã€æŠŠå¯¼å¸ˆå½“HRã€‚\r\n`.trim(),\r\n\r\n    script: `\r\nä½ æ­£åœ¨ä¼˜åŒ–çš„æ˜¯ã€é¢è¯•æ–‡å­—ç¨¿ã€‘ï¼ˆè‡ªæˆ‘ä»‹ç»/é¡¹ç›®è®²è§£/å¸¸è§é—®é¢˜å›ç­”ï¼‰ã€‚\r\nå…³æ³¨ï¼š1åˆ†é’Ÿ/3åˆ†é’Ÿä¸¤ç‰ˆï¼Œè‡ªæ´½ã€å¯è¿½é—®ã€å¯è½åœ°ã€‚\r\nå¿…é¡»è¾“å‡ºï¼š\r\n1) 1åˆ†é’Ÿè‡ªæˆ‘ä»‹ç»ç¨¿ + 3åˆ†é’Ÿè‡ªæˆ‘ä»‹ç»ç¨¿\r\n2) é¡¹ç›®è®²è§£æ¨¡æ¿ï¼šèƒŒæ™¯-ç›®æ ‡-æ–¹æ³•-ä½ çš„è´¡çŒ®-ç»“æœ-ä¸è¶³ä¸æ”¹è¿›ï¼ˆæ¯æ®µç»™ç¤ºä¾‹å¥ï¼‰\r\n3) 3ä¸ªé«˜é¢‘è¿½é—®ç‚¹ + å‚è€ƒå›ç­”ï¼ˆç®€æ´æœ‰è¯æ®ï¼‰\r\né¿å…ï¼šç©ºæ³›å½¢å®¹è¯ã€æ²¡æœ‰è¯æ®çš„\"æˆ‘å¾ˆçƒ­çˆ±ç§‘ç ”\"ã€‚\r\n`.trim(),\r\n\r\n    mock: `\r\nä½ ç°åœ¨æ‰®æ¼”ã€é¢è¯•å®˜ã€‘ï¼Œä¸ºä¿ç ”/å¤ä»¤è¥è¿›è¡Œæ¨¡æ‹Ÿæé—®ä¸è¿½é—®ã€‚\r\nè§„åˆ™ï¼š\r\n1) å…ˆåŸºäºPDFå†…å®¹ç»™å‡ºï¼š10ä¸ªé—®é¢˜ï¼ˆç”±æµ…å…¥æ·±ï¼Œè¦†ç›–åŠ¨æœº/æ–¹å‘/é¡¹ç›®/ç§‘ç ”æ–¹æ³•/åŸºç¡€çŸ¥è¯†/æœªæ¥è®¡åˆ’ï¼‰\r\n2) æ¯ä¸ªé—®é¢˜ç»™\"è€ƒå¯Ÿç‚¹\"\r\n3) å†éšæœºæŒ‘3é¢˜è¿›è¡ŒäºŒæ¬¡è¿½é—®ï¼ˆæ›´å°–é”ã€æ›´ç»†èŠ‚ï¼‰\r\n4) æœ€åç»™\"å›ç­”å»ºè®®æ¡†æ¶\"ï¼ˆSTAR/ç§‘ç ”äº”æ®µå¼ç­‰ï¼‰\r\né¿å…ï¼šä¼ä¸šé¢è¯•é¢˜ã€å…«è‚¡æ±‚èŒé¢˜ï¼ˆé™¤éç”¨æˆ·è¦æ±‚ï¼‰ã€‚\r\n`.trim()\r\n}\r\n\r\nconst showTypeModal = ref(false)\r\nconst typeConfirmed = ref(false)\r\n\r\nconst buildQuestion = userMsg => {\r\n    const typePrompt = TYPE_PROMPTS[docType.value] || ''\r\n    const typeLabel =\r\n        DOC_TYPE_OPTIONS.find(x => x.value === docType.value)?.label ||\r\n        docType.value\r\n\r\n    return `${PG_SYSTEM_PROMPT}\r\n\r\nã€ææ–™ç±»å‹ã€‘\r\n${typeLabel}\r\n\r\nã€è¯¥ç±»å‹ä¸“é¡¹è¦æ±‚ã€‘\r\n${typePrompt}\r\n\r\nã€ç”¨æˆ·é—®é¢˜ã€‘\r\n${userMsg}\r\n\r\nã€æ³¨æ„ã€‘\r\nè¯·ç»“åˆå·²ä¸Šä¼ PDFå†…å®¹ä½œç­”ï¼›é»˜è®¤æŒ‰ä¿ç ”/æ¨å…ç”³è¯·åœºæ™¯è¾“å‡ºï¼›ç»™å‡ºå¯ç›´æ¥å¤åˆ¶çš„ä¿®æ”¹ç¤ºä¾‹ã€‚`\r\n}\r\n\r\nimport md from '@/utils/markdown'\r\nimport DOMPurify from 'dompurify'\r\n\r\nconst normalizeMarkdown = (s = '') =>\r\n    s\r\n        // 1ï¸âƒ£ å»æ‰å…¨æ–‡ BOM / é›¶å®½å­—ç¬¦\r\n        .replace(/^\\uFEFF/, '')\r\n        .replace(/\\u200B/g, '')\r\n        // 2ï¸âƒ£ å…³é”®ï¼šå»æ‰â€œè¡Œé¦–æ‰€æœ‰ç©ºç™½ + #â€\r\n        .replace(/^[ \\t\\u3000]+(?=#{1,6}\\s*)/gm, '')\r\n\r\nconst renderMarkdown = text => {\r\n    const html = md.render(normalizeMarkdown(text || ''))\r\n    return DOMPurify.sanitize(html)\r\n}\r\n\r\nasync function streamSSEPost({ url, payload, signal, onEvent }) {\r\n    // âœ… [DBG] å¼€å§‹æ—¶é—´\r\n    const t0 = performance.now()\r\n    console.log('[SSE][T0] start', url)\r\n\r\n    const resp = await fetch(url, {\r\n        method: 'POST',\r\n        headers: {\r\n            'Content-Type': 'application/json',\r\n            Accept: 'text/event-stream'\r\n        },\r\n        body: JSON.stringify(payload),\r\n        signal\r\n    })\r\n\r\n    // âœ… [DBG] æ‹¿åˆ° headers\r\n    console.log(\r\n        '[SSE][T1] headers',\r\n        (performance.now() - t0).toFixed(1),\r\n        'ms',\r\n        'status=',\r\n        resp.status\r\n    )\r\n\r\n    if (!resp.ok) throw new Error(`HTTP ${resp.status}`)\r\n\r\n    const reader = resp.body.getReader()\r\n    const decoder = new TextDecoder('utf-8')\r\n\r\n    let pending = ''\r\n    let curEvent = 'message'\r\n    let curDataLines = []\r\n\r\n    // âœ… [DBG] ç¬¬ä¸€æ¬¡ chunk / ç¬¬ä¸€æ¬¡ emit\r\n    let firstChunkLogged = false\r\n    let firstEmitLogged = false\r\n\r\n    const emit = () => {\r\n        const data = curDataLines.join('\\n')\r\n\r\n        if (!firstEmitLogged) {\r\n            firstEmitLogged = true\r\n            console.log(\r\n                '[SSE][T3] first emit',\r\n                (performance.now() - t0).toFixed(1),\r\n                'ms',\r\n                'event=',\r\n                curEvent,\r\n                'dataLen=',\r\n                data.length\r\n            )\r\n        }\r\n\r\n        onEvent?.({ event: curEvent, data })\r\n    }\r\n\r\n    while (true) {\r\n        const { value, done } = await reader.read()\r\n        if (done) break\r\n\r\n        if (!firstChunkLogged) {\r\n            firstChunkLogged = true\r\n            console.log(\r\n                '[SSE][T2] first chunk',\r\n                (performance.now() - t0).toFixed(1),\r\n                'ms',\r\n                'bytes=',\r\n                value?.byteLength ?? 0\r\n            )\r\n        }\r\n\r\n        pending += decoder\r\n            .decode(value, { stream: true })\r\n            .replace(/\\r\\n/g, '\\n')\r\n\r\n        let idx\r\n        while ((idx = pending.indexOf('\\n\\n')) !== -1) {\r\n            const block = pending.slice(0, idx)\r\n            pending = pending.slice(idx + 2)\r\n\r\n            const lines = block.split('\\n')\r\n            curEvent = 'message'\r\n            curDataLines = []\r\n\r\n            for (const line of lines) {\r\n                if (!line || line.startsWith(':')) continue\r\n                if (line.startsWith('event:')) curEvent = line.slice(6).trim()\r\n                else if (line.startsWith('data:'))\r\n                    curDataLines.push(line.slice(5))\r\n            }\r\n\r\n            emit()\r\n\r\n            if (curEvent === 'done' || curDataLines.join('\\n') === '[DONE]') {\r\n                try {\r\n                    reader.cancel()\r\n                } catch {}\r\n                return\r\n            }\r\n        }\r\n    }\r\n}\r\n\r\n// âœ… assistant å ä½ï¼šç”¨ reactive ä¿è¯åç»­ä¿®æ”¹èƒ½è§¦å‘è§†å›¾æ›´æ–°\r\nconst assistantId = genId()\r\n// messages.value.push({\r\n//     id: assistantId,\r\n//     role: 'assistant',\r\n//     content: '',\r\n//     html: null,\r\n//     streaming: true,\r\n//     timestamp: new Date()\r\n// })\r\n// messages.value.push(assistantMsg)\r\n\r\n// è®¡ç®—å±æ€§\r\nconst canSend = computed(() => {\r\n    return (\r\n        !isLoading.value &&\r\n        inputMessage.value.trim() &&\r\n        sessionId.value &&\r\n        typeConfirmed.value // âœ… å¿…é¡»å…ˆé€‰ç±»å‹\r\n    )\r\n})\r\n\r\n// åˆå§‹åŒ–æ¬¢è¿æ¶ˆæ¯\r\nonMounted(() => {\r\n    messages.value.push({\r\n        id: genId(),\r\n        role: 'assistant',\r\n        content:\r\n            'ä½ å¥½ï¼æˆ‘æ˜¯ã€Œä¿ç ”æ–‡ä¹¦AIåŠ©æ‰‹ã€ğŸ“„\\n\\næˆ‘å¯ä»¥å¸®ä½ é˜…è¯»å’Œæ‰“ç£¨ç®€å†/å¥—ç£ä¿¡/PPTå†…å®¹ï¼š\\n\\nâ€¢ ä¸Šä¼ PDFæ–‡ä»¶ï¼ˆæ”¯æŒæ‹–æ‹½ä¸Šä¼ ï¼‰\\n\\nâ€¢ è¯¢é—®æ–‡æ¡£ä¸­çš„ä»»ä½•å†…å®¹\\n\\nâ€¢ å¤šè½®å¯¹è¯ï¼Œè®°ä½ä¸Šä¸‹æ–‡\\n\\nâ€¢ æ™ºèƒ½æå–å…³é”®ä¿¡æ¯\\n\\nè¯·ä¸Šä¼ ä¸€ä»½PDFæ–‡ä»¶å¼€å§‹å§ï¼æ”¯æŒæœ€å¤š10é¡µçš„æ–‡æ¡£åˆ†æã€‚',\r\n        timestamp: new Date()\r\n    })\r\n})\r\n\r\n// ç›‘å¬æ¶ˆæ¯å˜åŒ–è‡ªåŠ¨æ»šåŠ¨ï¼ˆä»…é’ˆå¯¹æ–°æ¶ˆæ¯ï¼Œæµå¼æ—¶åœ¨ flush ä¸­å¤„ç†ï¼‰\r\nwatch(\r\n    () => messages.value.length,\r\n    () => {\r\n        nextTick(() => {\r\n            if (chatContainer.value) {\r\n                chatContainer.value.scrollTop = chatContainer.value.scrollHeight\r\n            }\r\n        })\r\n    }\r\n)\r\n\r\n// ç»„ä»¶å¸è½½å‰æ¸…é™¤ä¼šè¯\r\nonBeforeUnmount(() => {\r\n    // å–æ¶ˆæ­£åœ¨è¿›è¡Œçš„æµå¼è¯·æ±‚\r\n    try {\r\n        streamAborter.value?.abort?.()\r\n    } catch {}\r\n    clearSession()\r\n})\r\n\r\n// æ ¼å¼åŒ–æ—¶é—´\r\nconst formatTime = timestamp => {\r\n    const d = timestamp instanceof Date ? timestamp : new Date(timestamp)\r\n    const hours = d.getHours().toString().padStart(2, '0')\r\n    const minutes = d.getMinutes().toString().padStart(2, '0')\r\n    return `${hours}:${minutes}`\r\n}\r\n\r\n// æ ¼å¼åŒ–æ–‡ä»¶å¤§å°\r\nconst formatFileSize = bytes => {\r\n    if (bytes < 1024) return bytes + ' B'\r\n    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB'\r\n    return (bytes / (1024 * 1024)).toFixed(1) + ' MB'\r\n}\r\n\r\n// æ¸…é™¤ä¼šè¯\r\nconst clearSession = async () => {\r\n    if (!sessionId.value) return\r\n    try {\r\n        await clearPdfSessionAPI(sessionId.value)\r\n    } catch (error) {\r\n        console.error('æ¸…é™¤ä¼šè¯å¤±è´¥:', error)\r\n    }\r\n}\r\n\r\n// æ–‡ä»¶é€‰æ‹©å¤„ç†\r\nconst handleFileSelect = event => {\r\n    handleFileUpload(Array.from(event.target.files || []))\r\n    event.target.value = ''\r\n}\r\n\r\n// æ‹–æ‹½æ”¾ç½®å¤„ç†\r\nconst handleDrop = event => {\r\n    isDragging.value = false\r\n    handleFileUpload(Array.from(event.dataTransfer.files || []))\r\n}\r\n\r\n// æ–‡ä»¶ä¸Šä¼ å¤„ç†ï¼ˆaxiosç‰ˆï¼‰\r\nconst handleFileUpload = async files => {\r\n    const validFiles = files.filter(file => {\r\n        if (!file.name.toLowerCase().endsWith('.pdf')) {\r\n            alert(`æ–‡ä»¶ \"${file.name}\" ä¸æ˜¯PDFæ ¼å¼`)\r\n            return false\r\n        }\r\n        if (file.size > 10 * 1024 * 1024) {\r\n            alert(`æ–‡ä»¶ \"${file.name}\" è¶…è¿‡ 10MB é™åˆ¶`)\r\n            return false\r\n        }\r\n        return true\r\n    })\r\n    if (validFiles.length === 0) return\r\n\r\n    const file = validFiles[0]\r\n\r\n    // å¦‚æœå·²æœ‰ä¼šè¯ï¼Œå…ˆæ¸…é™¤\r\n    if (sessionId.value) {\r\n        await clearSession()\r\n        sessionId.value = null\r\n        pdfInfo.value = null\r\n    }\r\n\r\n    isLoading.value = true\r\n\r\n    try {\r\n        const formData = new FormData()\r\n        formData.append('file', file)\r\n\r\n        const body = await uploadPdfAPI(formData)\r\n\r\n        uploadedFiles.value = [{ name: file.name, size: file.size, file }]\r\n\r\n        sessionId.value = body.data.session_id\r\n        pdfInfo.value = body.data\r\n\r\n        messages.value.push({\r\n            id: genId(),\r\n            role: 'assistant',\r\n            content: `âœ… PDFæ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼\\n\\næ–‡ä»¶åï¼š${\r\n                body.data.filename\r\n            }\\né¡µæ•°ï¼š${body.data.page_count} é¡µ\\n${\r\n                body.data.page_count > 10 ? 'ï¼ˆå°†åˆ†æå‰10é¡µå†…å®¹ï¼‰\\n' : ''\r\n            }\\nç°åœ¨ä½ å¯ä»¥å‘æˆ‘æé—®å…³äºè¿™ä»½æ–‡æ¡£çš„ä»»ä½•é—®é¢˜äº†ï¼`,\r\n            timestamp: new Date()\r\n        })\r\n\r\n        // âœ… ä¸Šä¼ åè¦æ±‚å…ˆé€‰æ‹©ææ–™ç±»å‹\r\n        showTypeModal.value = true\r\n        typeConfirmed.value = false\r\n\r\n        messages.value.push({\r\n            id: genId(),\r\n            role: 'assistant',\r\n            content:\r\n                'ğŸ“Œ è¯·å…ˆé€‰æ‹©è¿™ä»½PDFå±äºå“ªç§ææ–™ï¼š\\n\\n (1) ç®€å†  (2) é¢è¯•PPT  (3) å¥—ç£é‚®ä»¶  (4) é¢è¯•æ–‡å­—ç¨¿  (5) æ¨¡æ‹Ÿæé—® \\n\\né€‰æ‹©åæˆ‘ä¼šæŒ‰å¯¹åº”åœºæ™¯ç»™ä½ æ›´ç²¾å‡†çš„å»ºè®®ã€‚',\r\n            timestamp: new Date()\r\n        })\r\n    } catch (err) {\r\n        console.error('[upload err]', err)\r\n\r\n        messages.value.push({\r\n            id: genId(),\r\n            role: 'assistant',\r\n            content: `âŒ ä¸Šä¼ å¤±è´¥ï¼š${err.message || 'æœªçŸ¥é”™è¯¯'}`,\r\n            timestamp: new Date()\r\n        })\r\n    } finally {\r\n        isLoading.value = false\r\n    }\r\n}\r\n\r\n// ç§»é™¤æ–‡ä»¶\r\nconst removeFile = async () => {\r\n    if (sessionId.value) {\r\n        await clearSession()\r\n        sessionId.value = null\r\n        pdfInfo.value = null\r\n    }\r\n    uploadedFiles.value = []\r\n    messages.value.push({\r\n        id: genId(),\r\n        role: 'assistant',\r\n        content: 'æ–‡ä»¶å·²ç§»é™¤ï¼Œè¯·ä¸Šä¼ æ–°çš„PDFæ–‡ä»¶å¼€å§‹å¯¹è¯ã€‚',\r\n        timestamp: new Date()\r\n    })\r\n}\r\n\r\nconst renderStreamingMarkdown = text => {\r\n    if (!text) return ''\r\n\r\n    return DOMPurify.sanitize(\r\n        text\r\n            // æ¢è¡Œ\r\n            .replace(/\\n/g, '<br/>')\r\n            // åŠ ç²—\r\n            .replace(/\\*\\*(.+?)\\*\\*/g, '<strong>$1</strong>')\r\n            // åˆ—è¡¨\r\n            .replace(/^\\s*[-*]\\s+(.*)$/gm, 'â€¢ $1')\r\n    )\r\n}\r\n\r\n// âœ… å‘é€æ¶ˆæ¯ï¼ˆæµå¼ç‰ˆ + rAF + æ‰“å­—æœºèŠ‚æµï¼‰\r\nconst handleSendMessage = async () => {\r\n    if (!canSend.value) return\r\n\r\n    const userMsg = inputMessage.value.trim()\r\n    messages.value.push({\r\n        role: 'user',\r\n        content: userMsg,\r\n        timestamp: new Date()\r\n    })\r\n    inputMessage.value = ''\r\n    isLoading.value = true\r\n\r\n    // âœ… assistant å ä½ï¼šå¿…é¡» reactive\r\n    const assistantMsg = reactive({\r\n        role: 'assistant',\r\n        content: '',\r\n        html: null,\r\n        streaming: true,\r\n        timestamp: new Date()\r\n    })\r\n    messages.value.push(assistantMsg)\r\n    waitingFirstToken.value = true\r\n\r\n    // âœ… AbortController\r\n    const ac = new AbortController()\r\n    streamAborter.value = ac\r\n\r\n    // ====== æ‰“å­—æœºå‚æ•°ï¼ˆä½ åªè°ƒè¿™ä¸¤ä¸ªï¼‰======\r\n    const CHUNK_CHARS = 4 // æ¯æ¬¡åå‡ ä¸ªå­—ï¼ˆå°=æ…¢ï¼‰\r\n    const TICK_MS = 60 // é—´éš” msï¼ˆå¤§=æ…¢ï¼‰\r\n    // ======================================\r\n\r\n    let queue = ''\r\n    let timer = null\r\n    let ended = false\r\n\r\n    const forceRerender = () => {\r\n        // âœ… å…³é”®ï¼šå¼ºåˆ¶ Vue è§¦å‘ä¸€æ¬¡ v-for çš„æ›´æ–°ï¼ˆè§£å†³ä½ ç°åœ¨çš„â€œæ°”æ³¡ç©ºç™½â€ï¼‰\r\n        messages.value = [...messages.value]\r\n    }\r\n\r\n    const startTyping = () => {\r\n        if (timer) return\r\n        timer = setInterval(() => {\r\n            if (!queue) {\r\n                if (ended) {\r\n                    clearInterval(timer)\r\n                    timer = null\r\n                    assistantMsg.streaming = false\r\n                    assistantMsg.html = renderMarkdown(assistantMsg.content)\r\n                    forceRerender()\r\n                }\r\n                return\r\n            }\r\n\r\n            const take = queue.slice(0, CHUNK_CHARS)\r\n            queue = queue.slice(CHUNK_CHARS)\r\n\r\n            assistantMsg.content += take\r\n            forceRerender()\r\n\r\n            nextTick(() => {\r\n                if (chatContainer.value) {\r\n                    chatContainer.value.scrollTop =\r\n                        chatContainer.value.scrollHeight\r\n                }\r\n            })\r\n        }, TICK_MS)\r\n    }\r\n\r\n    try {\r\n        await streamSSEPost({\r\n            url: '/api/pdf/chat/stream', // èµ°ä½ å‰ç«¯ proxy çš„è·¯å¾„\r\n            payload: {\r\n                session_id: sessionId.value,\r\n                question: buildQuestion(userMsg)\r\n            },\r\n            signal: ac.signal,\r\n            onEvent: ({ event, data }) => {\r\n                if (event === 'token') {\r\n                    // âœ… ç¬¬ä¸€ä¸ªâ€œéç©º tokenâ€åˆ°æ¥\r\n                    if (\r\n                        waitingFirstToken.value &&\r\n                        data &&\r\n                        data.replace(/\\u200b/g, '').trim()\r\n                    ) {\r\n                        waitingFirstToken.value = false\r\n                        console.log(\r\n                            '[UI][FIRST_TOKEN] got',\r\n                            performance.now().toFixed(1),\r\n                            'ms',\r\n                            'token=',\r\n                            data\r\n                        )\r\n\r\n                        requestAnimationFrame(() => {\r\n                            console.log(\r\n                                '[UI][PAINT] after first token',\r\n                                performance.now().toFixed(1),\r\n                                'ms'\r\n                            )\r\n                        })\r\n                    }\r\n\r\n                    queue += data ?? ''\r\n                    startTyping()\r\n                } else if (event === 'done' || data === '[DONE]') {\r\n                    waitingFirstToken.value = false\r\n                    ended = true\r\n                } else if (event === 'error') {\r\n                    waitingFirstToken.value = false\r\n                    ended = true\r\n                    queue += `\\n\\nâŒ ${data || 'æµå¼å¼‚å¸¸'}`\r\n                    startTyping()\r\n                }\r\n            }\r\n        })\r\n        ended = true\r\n    } catch (e) {\r\n        if (e?.name !== 'AbortError') {\r\n            ended = true\r\n            queue += `\\n\\nâŒ æµå¼å¤±è´¥ï¼š${e?.message || e}`\r\n            startTyping()\r\n        }\r\n    } finally {\r\n        isLoading.value = false\r\n        streamAborter.value = null\r\n    }\r\n}\r\n</script>\r\n\r\n<style scoped>\r\n.pdf-agent-page {\r\n    height: calc(100vh - 60px);\r\n    display: flex;\r\n    flex-direction: column;\r\n    background-color: var(--home-bg, #ffffff);\r\n    margin-top: 60px;\r\n}\r\n\r\n/* èŠå¤©å®¹å™¨ */\r\n.chat-container {\r\n    flex: 1;\r\n    overflow-y: auto;\r\n    padding: 20px 40px;\r\n    display: flex;\r\n    flex-direction: column;\r\n    gap: 20px;\r\n}\r\n\r\n.chat-message {\r\n    display: flex;\r\n    animation: slideIn 0.3s ease;\r\n}\r\n\r\n@keyframes slideIn {\r\n    from {\r\n        opacity: 0;\r\n        transform: translateY(10px);\r\n    }\r\n    to {\r\n        opacity: 1;\r\n        transform: translateY(0);\r\n    }\r\n}\r\n\r\n.chat-message.user {\r\n    justify-content: flex-end;\r\n}\r\n\r\n.chat-message.assistant {\r\n    justify-content: flex-start;\r\n}\r\n\r\n.message-content {\r\n    max-width: 70%;\r\n    padding: 14px 18px;\r\n    border-radius: 12px;\r\n    background: var(--card-bg, #fff);\r\n    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);\r\n}\r\n\r\n.chat-message.user .message-content {\r\n    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\r\n    color: white;\r\n    border-bottom-right-radius: 4px;\r\n}\r\n\r\n.chat-message.assistant .message-content {\r\n    background: var(--card-bg, #fff);\r\n    color: var(--text-primary, #333);\r\n    border-bottom-left-radius: 4px;\r\n    border: 1px solid var(--border-color, #e0e0e0);\r\n}\r\n\r\n.message-text {\r\n    line-height: 1.6;\r\n    word-break: break-word;\r\n}\r\n\r\n.message-time {\r\n    margin-top: 6px;\r\n    font-size: 11px;\r\n    opacity: 0.6;\r\n    text-align: right;\r\n}\r\n\r\n/* ä¸“é—¨ç»™ AI è¾“å‡ºç”¨ */\r\n.assistant-markdown {\r\n    padding: 6px 4px;\r\n}\r\n\r\n/* âœ… æµå¼é˜¶æ®µï¼šçº¯æ–‡æœ¬æ˜¾ç¤º */\r\n.assistant-streaming {\r\n    white-space: pre-wrap;\r\n    word-break: break-word;\r\n    line-height: 1.7;\r\n    font-size: 14px;\r\n}\r\n\r\n/* æ‰“å­—åŠ¨ç”» */\r\n.typing-indicator {\r\n    display: flex;\r\n    gap: 4px;\r\n    padding: 4px 0;\r\n}\r\n\r\n.typing-indicator span {\r\n    width: 8px;\r\n    height: 8px;\r\n    border-radius: 50%;\r\n    background: #667eea;\r\n    animation: typing 1.4s infinite ease-in-out;\r\n}\r\n\r\n.typing-indicator span:nth-child(1) {\r\n    animation-delay: 0s;\r\n}\r\n\r\n.typing-indicator span:nth-child(2) {\r\n    animation-delay: 0.2s;\r\n}\r\n\r\n.typing-indicator span:nth-child(3) {\r\n    animation-delay: 0.4s;\r\n}\r\n\r\n@keyframes typing {\r\n    0%,\r\n    60%,\r\n    100% {\r\n        transform: translateY(0);\r\n        opacity: 0.5;\r\n    }\r\n    30% {\r\n        transform: translateY(-10px);\r\n        opacity: 1;\r\n    }\r\n}\r\n\r\n/* è¾“å…¥åŒºåŸŸ */\r\n.input-section {\r\n    padding: 16px 40px 20px;\r\n    background: var(--card-bg, #fff);\r\n    border-top: 1px solid var(--border-color, #e0e0e0);\r\n}\r\n\r\n.uploaded-files {\r\n    display: flex;\r\n    flex-wrap: wrap;\r\n    gap: 8px;\r\n    margin-bottom: 12px;\r\n}\r\n\r\n.file-chip {\r\n    display: inline-flex;\r\n    align-items: center;\r\n    gap: 6px;\r\n    padding: 6px 12px;\r\n    background: #f0f4ff;\r\n    border-radius: 16px;\r\n    font-size: 13px;\r\n    color: #333;\r\n}\r\n\r\n.file-size {\r\n    color: #999;\r\n    font-size: 11px;\r\n}\r\n\r\n.file-pages {\r\n    color: #667eea;\r\n    font-size: 11px;\r\n    font-weight: 500;\r\n}\r\n\r\n.remove-btn {\r\n    cursor: pointer;\r\n    color: #999;\r\n    font-size: 18px;\r\n    line-height: 1;\r\n    margin-left: 4px;\r\n    transition: color 0.2s;\r\n}\r\n\r\n.remove-btn:hover {\r\n    color: #f56c6c;\r\n}\r\n\r\n.input-box {\r\n    display: flex;\r\n    align-items: center;\r\n    gap: 12px;\r\n    padding: 12px 16px;\r\n    background: var(--home-bg, #fafafa);\r\n    border: 2px dashed var(--border-color, #e0e0e0);\r\n    border-radius: 12px;\r\n    transition: all 0.3s;\r\n}\r\n\r\n.input-box.drag-over {\r\n    background: #e8f0fe;\r\n    border-color: #667eea;\r\n}\r\n\r\n.icon-btn {\r\n    width: 36px;\r\n    height: 36px;\r\n    border: none;\r\n    border-radius: 8px;\r\n    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\r\n    color: white;\r\n    cursor: pointer;\r\n    display: flex;\r\n    align-items: center;\r\n    justify-content: center;\r\n    transition: all 0.2s;\r\n    flex-shrink: 0;\r\n}\r\n\r\n.icon-btn:hover:not(:disabled) {\r\n    transform: translateY(-2px);\r\n    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);\r\n}\r\n\r\n.icon-btn:disabled {\r\n    background: #ccc;\r\n    cursor: not-allowed;\r\n    transform: none;\r\n}\r\n\r\n.text-input {\r\n    flex: 1;\r\n    border: none;\r\n    background: transparent;\r\n    outline: none;\r\n    font-size: 14px;\r\n    color: var(--text-primary, #333);\r\n}\r\n\r\n.text-input::placeholder {\r\n    color: var(--text-tertiary, #999);\r\n}\r\n\r\n.text-input:disabled {\r\n    cursor: not-allowed;\r\n    opacity: 0.6;\r\n}\r\n\r\n.input-hint {\r\n    margin-top: 8px;\r\n    font-size: 12px;\r\n    color: var(--text-tertiary, #999);\r\n    text-align: center;\r\n}\r\n\r\n/* æ»šåŠ¨æ¡ */\r\n.chat-container::-webkit-scrollbar {\r\n    width: 6px;\r\n}\r\n\r\n.chat-container::-webkit-scrollbar-track {\r\n    background: transparent;\r\n}\r\n\r\n.chat-container::-webkit-scrollbar-thumb {\r\n    background: var(--border-color, #d0d0d0);\r\n    border-radius: 3px;\r\n}\r\n\r\n.chat-container::-webkit-scrollbar-thumb:hover {\r\n    background: #b0b0b0;\r\n}\r\n\r\n/* GitHub é£æ ¼ */\r\n.markdown-body {\r\n    font-size: 14px;\r\n    line-height: 1.7;\r\n}\r\n\r\n.markdown-body h3 {\r\n    margin-top: 1em;\r\n    font-weight: 600;\r\n}\r\n\r\n.markdown-body ul {\r\n    padding-left: 1.2em;\r\n}\r\n\r\n.markdown-body strong {\r\n    font-weight: 600;\r\n}\r\n\r\n/* å¼¹çª—æ ·å¼ */\r\n.modal-mask {\r\n    position: fixed;\r\n    inset: 0;\r\n    background: rgba(0, 0, 0, 0.35);\r\n    display: flex;\r\n    align-items: center;\r\n    justify-content: center;\r\n    z-index: 999;\r\n}\r\n\r\n.modal-card {\r\n    width: min(520px, 92vw);\r\n    background: #fff;\r\n    border-radius: 16px;\r\n    padding: 18px 18px 16px;\r\n    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);\r\n}\r\n\r\n.modal-title {\r\n    font-size: 16px;\r\n    font-weight: 700;\r\n    color: #111;\r\n}\r\n\r\n.modal-sub {\r\n    margin-top: 6px;\r\n    font-size: 13px;\r\n    color: #666;\r\n    line-height: 1.5;\r\n}\r\n\r\n.type-grid {\r\n    margin-top: 14px;\r\n    display: grid;\r\n    grid-template-columns: 1fr 1fr;\r\n    gap: 10px;\r\n}\r\n\r\n.type-btn {\r\n    border: 1px solid #e5e7eb;\r\n    background: #f9fafb;\r\n    border-radius: 12px;\r\n    padding: 10px 12px;\r\n    font-size: 13px;\r\n    cursor: pointer;\r\n    transition: 0.15s;\r\n}\r\n\r\n.type-btn:hover {\r\n    transform: translateY(-1px);\r\n}\r\n\r\n.type-btn.active {\r\n    border-color: #667eea;\r\n    background: #eef2ff;\r\n}\r\n\r\n.modal-actions {\r\n    margin-top: 14px;\r\n    display: flex;\r\n    justify-content: flex-end;\r\n}\r\n\r\n.confirm-btn {\r\n    border: none;\r\n    border-radius: 10px;\r\n    padding: 10px 14px;\r\n    cursor: pointer;\r\n    color: #fff;\r\n    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\r\n}\r\n\r\n.confirm-btn:hover {\r\n    opacity: 0.9;\r\n}\r\n\r\n.thinking-indicator {\r\n    display: flex;\r\n    align-items: center;\r\n    gap: 6px;\r\n    padding: 6px 0;\r\n    color: #667eea;\r\n    font-size: 13px;\r\n}\r\n\r\n.thinking-indicator span {\r\n    width: 6px;\r\n    height: 6px;\r\n    border-radius: 50%;\r\n    background: #667eea;\r\n    animation: thinking 1.4s infinite ease-in-out;\r\n}\r\n\r\n.thinking-indicator span:nth-child(1) {\r\n    animation-delay: 0s;\r\n}\r\n.thinking-indicator span:nth-child(2) {\r\n    animation-delay: 0.2s;\r\n}\r\n.thinking-indicator span:nth-child(3) {\r\n    animation-delay: 0.4s;\r\n}\r\n\r\n.thinking-text {\r\n    margin-left: 6px;\r\n    opacity: 0.7;\r\n}\r\n\r\n@keyframes thinking {\r\n    0%,\r\n    80%,\r\n    100% {\r\n        transform: scale(0.6);\r\n        opacity: 0.4;\r\n    }\r\n    40% {\r\n        transform: scale(1);\r\n        opacity: 1;\r\n    }\r\n}\r\n\r\n/* å“åº”å¼ */\r\n@media (max-width: 768px) {\r\n    .chat-container {\r\n        padding: 16px 20px;\r\n    }\r\n\r\n    .input-section {\r\n        padding: 12px 20px 16px;\r\n    }\r\n\r\n    .message-content {\r\n        max-width: 85%;\r\n    }\r\n}\r\n</style>\r\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}